

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Simulation Experiments &#8212; Contaminated RCT</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=365ca57ee442770a23c6"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'cluster_contaminated_rct';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
  
    <p class="title logo__title">Contaminated RCT</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="derive_cluster_sample_size_formula.html">Sample size calculation</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Simulation Experiments</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="simulation-experiments">
<h1>Simulation Experiments<a class="headerlink" href="#simulation-experiments" title="Permalink to this heading">#</a></h1>
<p><span class="math notranslate nohighlight">\(\large{\textbf{Cluster randomization}}\)</span></p>
<p>Induce contamination by changing x% of the control arm indicator to intervention. Evaluate if this approach of inducing contamination agrees with the closed-form formula.</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input tag_remote-output docutils container">
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading required package: Matrix


Attaching package: ‘Matrix’


The following objects are masked from ‘package:tidyr’:

    expand, pack, unpack


Loading required package: foreach

Loading required package: iterators
</pre></div>
</div>
</div>
</div>
<p><span class="math notranslate nohighlight">\(\large{\textbf{Why way? Individual or cluster rct? }}\)</span></p>
<p>Examine critical rate of contamination before the sample size required for individual rct with contamination becomes larger than cluster rct. For this, implement the functions in ‘Hemming, Karla, et al. “Contamination: How much can an individually randomized trial tolerate?.” Statistics in Medicine 40.14 (2021): 3329-3351.’</p>
<p>This happens when</p>
<div class="math notranslate nohighlight">
\[ 2\sigma^2 \left[\frac{(z_{\alpha/2}+z_{\beta}  )^2}{ ((1-\omega)\delta)^2 } \right] &gt;2\sigma^2 \left[\frac{(z_{\alpha/2}+z_{\beta}  )^2}{ \delta^2 } \right] [1+(m-1) \rho] \]</div>
<p>where m is the cluster size and <span class="math notranslate nohighlight">\(\rho\)</span> is the intra-cluster correlation (icc).</p>
<p>For consistency with a real-life clinical setting where the number of doctors are usually fixed, we can convert the formula above to be a function of <span class="math notranslate nohighlight">\(k\)</span>, the number of clusters as opposed to the number of subjects per cluster (i.e., cluster size).</p>
<p>Let</p>
<div class="math notranslate nohighlight">
\[n_i=2\sigma^2 \left[\frac{(z_{\alpha/2}+z_{\beta}  )^2}{ \delta^2 } \right]\]</div>
<p>Then</p>
<div class="math notranslate nohighlight">
\[\frac{n_i}{(1-\omega)^2} &gt; n_i[1+(m-1) \rho]  \]</div>
<p><span class="math notranslate nohighlight">\(\Longleftrightarrow\)</span></p>
<div class="math notranslate nohighlight">
\[ \frac{n_i}{(1-\omega)^2} &gt; n_i \frac{k(1-\rho)}{[k-n_i\rho]}\]</div>
<p><span class="math notranslate nohighlight">\(\Rightarrow\)</span></p>
<div class="math notranslate nohighlight">
\[\omega &gt; 1- \sqrt{ \frac{k-n_i\rho}{ k(1-\rho)} } \]</div>
<div class="cell tag_remove-input tag_hide-input tag_hide-output docutils container">
<details class="hide above-output">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell outputs</span>
<span class="expanded">Hide code cell outputs</span>
</summary>
<div class="cell_output docutils container">
<img alt="_images/7f64060453effc666c789276d19e5cfb292dda9d4467a51e29913335c9af8b66.png" src="_images/7f64060453effc666c789276d19e5cfb292dda9d4467a51e29913335c9af8b66.png" />
</div>
</details>
</div>
<div class="cell tag_remove-input tag_hide-output docutils container">
<details class="hide above-output">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell outputs</span>
<span class="expanded">Hide code cell outputs</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 6 × 4</caption>
<thead>
	<tr><th></th><th scope=col>critical.rate</th><th scope=col>ni</th><th scope=col>no.cluster</th><th scope=col>icc</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>0.00000000</td><td>500</td><td>10</td><td>0.0000000000</td></tr>
	<tr><th scope=row>2</th><td>0.01005463</td><td>500</td><td>10</td><td>0.0004081633</td></tr>
	<tr><th scope=row>3</th><td>0.02022078</td><td>500</td><td>10</td><td>0.0008163265</td></tr>
	<tr><th scope=row>4</th><td>0.03050196</td><td>500</td><td>10</td><td>0.0012244898</td></tr>
	<tr><th scope=row>5</th><td>0.04090190</td><td>500</td><td>10</td><td>0.0016326531</td></tr>
	<tr><th scope=row>6</th><td>0.05142449</td><td>500</td><td>10</td><td>0.0020408163</td></tr>
</tbody>
</table>
</div><div class="output text_html"><table class="dataframe">
<caption>A data.frame: 6 × 4</caption>
<thead>
	<tr><th></th><th scope=col>critical.rate</th><th scope=col>ni</th><th scope=col>no.cluster</th><th scope=col>icc</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>445</th><td>0.6756709</td><td>1500</td><td>50</td><td>0.02993197</td></tr>
	<tr><th scope=row>446</th><td>0.7098095</td><td>1500</td><td>50</td><td>0.03061224</td></tr>
	<tr><th scope=row>447</th><td>0.7485994</td><td>1500</td><td>50</td><td>0.03129252</td></tr>
	<tr><th scope=row>448</th><td>0.7946602</td><td>1500</td><td>50</td><td>0.03197279</td></tr>
	<tr><th scope=row>449</th><td>0.8547518</td><td>1500</td><td>50</td><td>0.03265306</td></tr>
	<tr><th scope=row>450</th><td>1.0000000</td><td>1500</td><td>50</td><td>0.03333333</td></tr>
</tbody>
</table>
</div></div>
</details>
</div>
<div class="cell tag_remove-input tag_hide-output docutils container">
<details class="hide above-output">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell outputs</span>
<span class="expanded">Hide code cell outputs</span>
</summary>
<div class="cell_output docutils container">
<img alt="_images/42eb9f5dd09933d31b35c9b710ab580441a38b9c51dbdadb562ff9ba04e7ee89.png" src="_images/42eb9f5dd09933d31b35c9b710ab580441a38b9c51dbdadb562ff9ba04e7ee89.png" />
</div>
</details>
</div>
<p><span class="math notranslate nohighlight">\(\large{\textbf{Simulate data from a mixed effects model (cluster=doctors)}}\)</span></p>
<p><span class="math notranslate nohighlight">\(\color{red}{ \text{Subjects within the same cluster are correlated!}}\)</span></p>
<p>For now, start with subjects within the same cluster receiving the same treatment; either intervention or control but never both. This way, we can control for the contamination problem.</p>
<p>Later, find a way to allow for contamination because we expect that doctors may end up seeing patients from both intervention and control groups.</p>
<ul class="simple">
<li><p>Is allowing for some correlation of observations between the two treatments a valid approach to mitigating contamination? The answer is likely to be yes. But this correlation structure would lead to an increased in sample size as well. Either way, investigate if this covariance structure ( hierarchical modeling) can be used during the design of an experiment.</p></li>
</ul>
<p><span class="math notranslate nohighlight">\(\textbf{Model 1}\)</span></p>
<div class="math notranslate nohighlight">
\[Y_{ijk}=\beta_i+\tau_j+\epsilon_{ijk}\]</div>
<p>where <span class="math notranslate nohighlight">\(\beta_i\)</span> is treatment i effect(i=0,1), <span class="math notranslate nohighlight">\(\tau_j\)</span> is the random effect of cluster j (j=1,…,b), <span class="math notranslate nohighlight">\(\epsilon_{ijk}\)</span> is the random error for subject k (k=1,…,K) in treatment i and cluster j.  <span class="math notranslate nohighlight">\(\beta_j \sim N(0, \sigma_{\beta}^2)\)</span>, <span class="math notranslate nohighlight">\(\epsilon_{ijk} \sim N(0, \sigma_{\epsilon}^2)\)</span>,  <span class="math notranslate nohighlight">\(\epsilon_{ijk} \text{ and } \beta_j\)</span> are independent.</p>
<p>Note that</p>
<p><span class="math notranslate nohighlight">\(\text{intra-class correlation(ICC)}=\frac{\sigma_{\tau}^2 }{ \sigma_{\tau}^2 + \sigma_{\epsilon}^2}\)</span></p>
<p><span class="math notranslate nohighlight">\(\Rightarrow \sigma_{\tau}^2=\frac{ICC}{1-ICC} \times \sigma_{\epsilon}^2 \)</span>
so that we can use ICC values from literature.</p>
<p>Caveat: The mixed effects may run into convergence problems during simulation. This can be frustrating a times.</p>
<div class="cell tag_remove-input tag_hide-output docutils container">
<details class="hide above-output">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell outputs</span>
<span class="expanded">Hide code cell outputs</span>
</summary>
<div class="cell_output docutils container">
<img alt="_images/cc6e0807664a809f49d41e9deebadcd13e3b3cdd98fd911864ddb3cae4bb787c.png" src="_images/cc6e0807664a809f49d41e9deebadcd13e3b3cdd98fd911864ddb3cae4bb787c.png" />
</div>
</details>
</div>
<div class="cell tag_remove-input tag_hide-output docutils container">
<details class="hide above-output">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell outputs</span>
<span class="expanded">Hide code cell outputs</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_html">200</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>          trt
cluster_id  0  1
        1  19  0
        2  16  0
        3  29  0
        4  17  0
        5  19  0
        6  25  0
        7   0 24
        8   0 18
        9   0 14
        10 19  0
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>clust.vec
 -0.701866383664827 -0.0966379691780691  0.0680741685107229    0.25145367872838 
                 18                  14                  19                  25 
  0.251824302700206   0.275479638068053   0.372055670061381   0.398054982019239 
                 17                  19                  16                  19 
  0.798856522209642    2.01306267771619 
                 24                  29 
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cluster_id
 1  2  3  4  5  6  7  8  9 10 
19 16 29 17 19 25 24 18 14 19 
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/a2451af0955c8180284c2d35cfbba0acf7576e23c3648af8d055d72b5129922e.png" src="_images/a2451af0955c8180284c2d35cfbba0acf7576e23c3648af8d055d72b5129922e.png" />
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input tag_hide-output docutils container">
<details class="hide above-output">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell outputs</span>
<span class="expanded">Hide code cell outputs</span>
</summary>
<div class="cell_output docutils container">
<img alt="_images/a8477c72d67042f712e84bdb06cc960ac8e8357fdaea03b42d76f62126c6911f.png" src="_images/a8477c72d67042f712e84bdb06cc960ac8e8357fdaea03b42d76f62126c6911f.png" />
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Loop over increasing number of clusters</span>

<span class="n">cluster.vec</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="m">30</span><span class="p">,</span><span class="w"> </span><span class="m">50</span><span class="p">)</span>
<span class="n">icc.mat</span><span class="o">=</span><span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">),</span><span class="w"> </span><span class="n">nrow</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="n">pwr.vs.icc.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">()</span><span class="w"> </span><span class="c1"># empty data frame. </span>

<span class="nf">for </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">cluster.vec</span><span class="p">)){</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">nsim</span><span class="o">=</span><span class="m">100</span>
<span class="w">    </span><span class="n">ni</span><span class="o">=</span><span class="m">300</span><span class="w"> </span><span class="c1"># subjects per treatment group</span>
<span class="w">    </span><span class="n">beta</span><span class="o">=</span><span class="m">0.2</span>
<span class="w">    </span><span class="n">k</span><span class="o">=</span><span class="n">cluster.vec</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="c1"># increasing cluster size</span>

<span class="w">    </span><span class="n">pwr.vs.icc</span><span class="o">=</span><span class="nf">apply</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">icc.mat</span><span class="p">,</span><span class="n">MARGIN</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="o">=</span><span class="n">pwr.vs.cluster.size</span><span class="p">)</span>
<span class="w">    </span><span class="n">temp</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">icc</span><span class="o">=</span><span class="n">icc.mat</span><span class="p">[</span><span class="m">1</span><span class="p">,],</span><span class="w"> </span><span class="n">pwr</span><span class="o">=</span><span class="n">pwr.vs.icc</span><span class="p">,</span><span class="w"> </span><span class="n">number.of.clusters</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">pwr.vs.icc</span><span class="p">)</span><span class="w"> </span><span class="p">))</span>
<span class="w">    </span><span class="n">pwr.vs.icc.df</span><span class="o">=</span><span class="nf">rbind</span><span class="p">(</span><span class="n">pwr.vs.icc.df</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input tag_hide-output docutils container">
<details class="hide above-output">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell outputs</span>
<span class="expanded">Hide code cell outputs</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 20 × 3</caption>
<thead>
	<tr><th scope=col>icc</th><th scope=col>pwr</th><th scope=col>number.of.clusters</th></tr>
	<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>0.00</td><td>0.66</td><td>10</td></tr>
	<tr><td>0.01</td><td>0.55</td><td>10</td></tr>
	<tr><td>0.05</td><td>0.51</td><td>10</td></tr>
	<tr><td>0.10</td><td>0.41</td><td>10</td></tr>
	<tr><td>0.50</td><td>0.07</td><td>10</td></tr>
	<tr><td>0.00</td><td>0.58</td><td>20</td></tr>
	<tr><td>0.01</td><td>0.63</td><td>20</td></tr>
	<tr><td>0.05</td><td>0.63</td><td>20</td></tr>
	<tr><td>0.10</td><td>0.47</td><td>20</td></tr>
	<tr><td>0.50</td><td>0.07</td><td>20</td></tr>
	<tr><td>0.00</td><td>0.66</td><td>30</td></tr>
	<tr><td>0.01</td><td>0.67</td><td>30</td></tr>
	<tr><td>0.05</td><td>0.65</td><td>30</td></tr>
	<tr><td>0.10</td><td>0.41</td><td>30</td></tr>
	<tr><td>0.50</td><td>0.09</td><td>30</td></tr>
	<tr><td>0.00</td><td>0.67</td><td>50</td></tr>
	<tr><td>0.01</td><td>0.66</td><td>50</td></tr>
	<tr><td>0.05</td><td>0.61</td><td>50</td></tr>
	<tr><td>0.10</td><td>0.60</td><td>50</td></tr>
	<tr><td>0.50</td><td>0.07</td><td>50</td></tr>
</tbody>
</table>
</div></div>
</details>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/889589b61669f0597ccb15be1b102c12e95a394c4623ea676694133c58c608d0.png" src="_images/889589b61669f0597ccb15be1b102c12e95a394c4623ea676694133c58c608d0.png" />
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/e8155e77923c6cc2d7af6b13923f88df09a40b3ff26fceef1162591abd500c66.png" src="_images/e8155e77923c6cc2d7af6b13923f88df09a40b3ff26fceef1162591abd500c66.png" />
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<p><span class="math notranslate nohighlight">\(\Large{\textbf{Randomized patients to treatment first, then to clusters}}\)</span></p>
<p>This kind of randomization scheme protects against confouders. However, it poses some significant challenges when it comes to implementation.</p>
<p>My strategy to implement this kind of randomization trial.</p>
<ol class="arabic simple">
<li><p>Randomize patients to treatment</p></li>
<li><p>For a fixed number of doctors, randomize them to treatment</p></li>
<li><p>For patients in treatment==1, they can be treated only by one of the doctors assigned to only treatment==1. For patients in treatment==0, they can be treated by one of the doctors assigned to only treatment==0.</p></li>
<li><p>Induce contamination on treatment as desired</p></li>
<li><p>Evaluate the impact on statistical power with and without contamination</p></li>
<li><p>Investigate if include doctor’s random slope  within a treatment minimizes reduction in power in the presence of contamination.</p></li>
</ol>
<div class="cell tag_remove-input tag_hide-output docutils container">
<details class="hide above-output">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell outputs</span>
<span class="expanded">Hide code cell outputs</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                 trt
cluster.assigment  0  1
               1   0 20
               2  31  0
               3   0 13
               4   0 12
               5   0 17
               6   0 13
               7  34  0
               8  37  0
               9   0  8
               10  0 15
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cluster.assigment
 1  2  3  4  5  6  7  8  9 10 
20 31 13 12 17 13 34 37  8 15 
</pre></div>
</div>
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 6 × 4</caption>
<thead>
	<tr><th></th><th scope=col>y</th><th scope=col>trt</th><th scope=col>cluster.assigned</th><th scope=col>cluster_random_interc</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>-1.4358419</td><td>1</td><td>6</td><td>-1.2842741</td></tr>
	<tr><th scope=row>2</th><td> 0.2674184</td><td>1</td><td>1</td><td> 0.1507544</td></tr>
	<tr><th scope=row>3</th><td> 2.0007483</td><td>0</td><td>7</td><td> 0.1242800</td></tr>
	<tr><th scope=row>4</th><td>-2.0702323</td><td>1</td><td>5</td><td>-1.4097732</td></tr>
	<tr><th scope=row>5</th><td>-0.0540591</td><td>0</td><td>8</td><td>-0.5895021</td></tr>
	<tr><th scope=row>6</th><td>-0.3742950</td><td>1</td><td>6</td><td>-1.2842741</td></tr>
</tbody>
</table>
</div></div>
</details>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>0.77</li><li>0.82</li><li>0.69</li><li>0.49</li><li>0.1</li></ol>
</div></div>
</div>
<div class="cell tag_remove-input tag_hide-output docutils container">
<details class="hide above-output">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell outputs</span>
<span class="expanded">Hide code cell outputs</span>
</summary>
<div class="cell_output docutils container">
<img alt="_images/ecf9c04c748bc56cef05f6a620e87952976c7f740b190276d1b395d3473a3968.png" src="_images/ecf9c04c748bc56cef05f6a620e87952976c7f740b190276d1b395d3473a3968.png" />
</div>
</details>
</div>
<p><span class="math notranslate nohighlight">\(\Large{\textbf{Cluster rct with clinician's induced contamination}}\)</span></p>
<p>Evaluate the impact of clinicians seeing patients in both control and intervention. Under such a scenario, we expect some level of contamination even though the trial is cluster rct.</p>
<p>Investigate if including clinician as a random effect and adding random slope by treatment minimizes on the loss of statistical power when we have contamination.</p>
<p>In appears as though this is the kind of design that aligns with the one from Min and Bin. Now, instead of randomly assigning doctors to patients conditioned on treatment assignment, assign the patients to doctors in a random fashion. It is clear that there is going to be contamination. Unfortunately, we end up losing information on the directionality of the bais.</p>
<p>Is it still possible to estimate a debiased treatment effect under these settings? Bin is going to walk us through his taught process and how we can simulate data under this scenario and whether we can estimate the treatment effect.</p>
<p>From my conversation with Min and Bin, Bin suggested treating the contamination rate as a random variable as opposed to a fixed unkown value. He pondered whether one can then estimate this contamination rate from the observed data.</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>0.45</li><li>0.54</li><li>0.35</li><li>0.29</li><li>0.03</li></ol>
</div></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 10 × 3</caption>
<thead>
	<tr><th scope=col>icc</th><th scope=col>pwr</th><th scope=col>power</th></tr>
	<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th></tr>
</thead>
<tbody>
	<tr><td>0.00</td><td>0.77</td><td>without contamination</td></tr>
	<tr><td>0.01</td><td>0.82</td><td>without contamination</td></tr>
	<tr><td>0.05</td><td>0.69</td><td>without contamination</td></tr>
	<tr><td>0.10</td><td>0.49</td><td>without contamination</td></tr>
	<tr><td>0.50</td><td>0.10</td><td>without contamination</td></tr>
	<tr><td>0.00</td><td>0.45</td><td>with contamination   </td></tr>
	<tr><td>0.01</td><td>0.54</td><td>with contamination   </td></tr>
	<tr><td>0.05</td><td>0.35</td><td>with contamination   </td></tr>
	<tr><td>0.10</td><td>0.29</td><td>with contamination   </td></tr>
	<tr><td>0.50</td><td>0.03</td><td>with contamination   </td></tr>
</tbody>
</table>
</div></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/82856357041e05e303bbcf77d6cff13110ab900647d81275fd962e9565cf0a3b.png" src="_images/82856357041e05e303bbcf77d6cff13110ab900647d81275fd962e9565cf0a3b.png" />
</div>
</div>
<p><span class="math notranslate nohighlight">\(\textbf{Randomly assign doctors to patients without conditioning on treatment}\)</span></p>
<p>Strategy</p>
<ol class="arabic simple">
<li><p>Randomize individuals to treatment</p></li>
<li><p>Assign doctors/clusters to patients in a random fashion. With this randomization scheme, it is almost guaranteed that some doctors will be assigned to patients in both control and intervention. The scheme induces an intrinsic contamination.</p></li>
<li><p>Extract contaminated treatment variable</p></li>
<li><p>Use contaminated treatment variable to generate Y</p></li>
<li><p>Generate compliance variable</p></li>
<li><p>Compile the simulated variables into a data frame, making sure that the treatment variable is from the first step. Because that is what we would observe at the end of the trial.</p></li>
<li><p>Estimate statistical power with and without the compliance variable.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate data following the stragey above. It reflects the settings in UTI data from Min. </span>

<span class="nf">options</span><span class="p">(</span><span class="n">scipen</span><span class="o">=</span><span class="m">999</span><span class="p">)</span>
<span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="w"> </span><span class="c1"># treatment effect. </span>
<span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span>
<span class="c1"># calculate the required sample size for cluster randomization. Suppose that we have a fixed number of clusters and that there are equal number of subjects within each cluster. </span>
<span class="n">n.group1</span><span class="o">=</span><span class="nf">cont.sample.size</span><span class="p">(</span><span class="n">m1</span><span class="o">=</span><span class="m">9.0</span><span class="p">,</span>
<span class="w">                 </span><span class="n">m2</span><span class="o">=</span><span class="m">9.0</span><span class="o">+</span><span class="n">beta</span><span class="p">,</span>
<span class="w">                 </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_e</span><span class="p">,</span>
<span class="w">                 </span><span class="n">type_I_error</span><span class="o">=</span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span>
<span class="w">                 </span><span class="n">type_II_error</span><span class="o">=</span><span class="m">0.2</span><span class="p">)</span>


<span class="n">k</span><span class="o">=</span><span class="m">10</span><span class="w"> </span><span class="c1"># 10, 20, 50, 100 , the number of equal sized clusters</span>
<span class="n">ni</span><span class="o">=</span><span class="m">100</span><span class="w"> </span><span class="c1"># a fixed number of subjects per treatment group</span>
<span class="n">N</span><span class="o">=</span><span class="n">ni</span><span class="o">*</span><span class="m">2</span><span class="w"> </span><span class="c1"># total number of patients in the trial. </span>

<span class="c1"># calculate the variance for cluster random effect. </span>
<span class="n">icc</span><span class="o">=</span><span class="m">0.5</span><span class="w">   </span><span class="c1">#k/(n.group1) # maximum allowable icc for the current number of clusters is  k/n.group1</span>

<span class="n">sigma_b</span><span class="o">=</span><span class="n">icc</span><span class="o">*</span><span class="n">sigma_e</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">icc</span><span class="p">)</span>


<span class="c1"># Randomize patients to treatment </span>
<span class="n">trt</span><span class="o">=</span><span class="nf">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">prob</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>

<span class="c1">## If assigning doctors to patients in a random fashion without conditioning on treatment assigned to</span>
<span class="n">cluster.assigment</span><span class="o">=</span><span class="nf">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>

<span class="c1">## Extract proportion of intervention for each doctor/cluster</span>
<span class="n">cross.in.prop</span><span class="o">=</span><span class="nf">as.vector</span><span class="p">(</span><span class="w"> </span><span class="nf">prop.table</span><span class="p">(</span><span class="w"> </span><span class="nf">table</span><span class="p">(</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="p">),</span><span class="w"> </span><span class="n">margin</span><span class="o">=</span><span class="m">1</span><span class="p">)[,</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c1"># </span>

<span class="c1">## Assign these proportions to doctors </span>
<span class="n">interven.prop.vec</span><span class="o">=</span><span class="n">cross.in.prop</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="p">]</span>

<span class="c1">## If proportion of controls with a doctor is &gt; 0.5, given all the patients </span>
<span class="c1"># in that cluster intervention, otherwise keep the current treatment. </span>
<span class="n">trt.contam</span><span class="o">=</span><span class="n">trt</span>

<span class="n">trt.contam</span><span class="p">[</span><span class="n">interven.prop.vec</span><span class="o">&gt;</span><span class="m">0.5</span><span class="p">]</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="c1"># tipping point. </span>

<span class="n">compliance</span><span class="o">=</span><span class="p">(</span><span class="n">trt.contam</span><span class="o">==</span><span class="n">trt</span><span class="p">)</span><span class="o">*</span><span class="m">1</span><span class="w"> </span><span class="c1"># complaince variance </span>

<span class="nf">table</span><span class="p">(</span><span class="n">compliance</span><span class="p">)</span>
<span class="c1"># # x-beta </span>
<span class="n">xb</span><span class="o">=</span><span class="n">beta</span><span class="o">*</span><span class="n">trt.contam</span><span class="w"> </span><span class="c1"># make sure to use the treatment variable that acts behind the scene!</span>

<span class="c1"># # simulate cluster random intercept (for now)  </span>
<span class="n">clust.eff</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">sigma_b</span><span class="p">)</span><span class="w"> </span><span class="c1"># number of clusters is k</span>

<span class="n">clust.eff.vec</span><span class="o">=</span><span class="n">clust.eff</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="p">]</span><span class="w"> </span><span class="c1"># assign each cluster to its random intercept </span>

<span class="c1"># # generate outcome variable yijk using equation in model 1. </span>
<span class="n">y</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">xb</span><span class="p">,</span><span class="w">  </span><span class="n">sigma_e</span><span class="p">)</span><span class="o">+</span><span class="n">clust.eff.vec</span>

<span class="c1"># # combine into a dataframe </span>

<span class="n">clust.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="o">=</span><span class="n">trt</span><span class="p">,</span><span class="w"> </span><span class="n">compliance</span><span class="o">=</span><span class="n">compliance</span><span class="p">,</span><span class="w"> </span><span class="n">cluster.assigned</span><span class="o">=</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">cluster_random_interc</span><span class="o">=</span><span class="n">clust.eff.vec</span><span class="p">)</span><span class="w"> </span><span class="c1"># add icc, number of clusters at a later date. </span>

<span class="nf">head</span><span class="p">(</span><span class="n">clust.df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>compliance
  0   1 
 32 168 
</pre></div>
</div>
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 6 × 5</caption>
<thead>
	<tr><th></th><th scope=col>y</th><th scope=col>trt</th><th scope=col>compliance</th><th scope=col>cluster.assigned</th><th scope=col>cluster_random_interc</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>-0.382814961</td><td>0</td><td>0</td><td> 1</td><td> 0.9745812</td></tr>
	<tr><th scope=row>2</th><td>-0.994228589</td><td>0</td><td>1</td><td> 3</td><td>-0.8030315</td></tr>
	<tr><th scope=row>3</th><td> 0.223766989</td><td>1</td><td>1</td><td> 6</td><td>-0.2422453</td></tr>
	<tr><th scope=row>4</th><td> 0.775484384</td><td>0</td><td>1</td><td>10</td><td> 0.8296064</td></tr>
	<tr><th scope=row>5</th><td>-1.128624233</td><td>1</td><td>1</td><td> 2</td><td>-1.1979740</td></tr>
	<tr><th scope=row>6</th><td>-0.006074232</td><td>1</td><td>1</td><td>10</td><td> 0.8296064</td></tr>
</tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Emprical power vs ICC  where we randomize patients to treatment, then to clusters. </span>
<span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span>
<span class="n">beta</span><span class="o">=</span><span class="m">0.2</span>
<span class="n">k</span><span class="o">=</span><span class="m">10</span>
<span class="n">contam.rate</span><span class="o">=</span><span class="m">0.0</span>
<span class="n">ni</span><span class="o">=</span><span class="nf">cont.sample.size</span><span class="p">(</span><span class="n">m1</span><span class="o">=</span><span class="m">9.0</span><span class="p">,</span>
<span class="w">                 </span><span class="n">m2</span><span class="o">=</span><span class="m">9.0</span><span class="o">+</span><span class="n">beta</span><span class="p">,</span>
<span class="w">                 </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_e</span><span class="p">,</span>
<span class="w">                 </span><span class="n">type_I_error</span><span class="o">=</span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span>
<span class="w">                 </span><span class="n">type_II_error</span><span class="o">=</span><span class="m">0.2</span><span class="p">)</span>

<span class="n">N</span><span class="o">=</span><span class="n">ni</span><span class="o">*</span><span class="m">2</span>
<span class="n">nsim</span><span class="o">=</span><span class="m">100</span>
<span class="n">tipping.point</span><span class="o">=</span><span class="m">0.5</span>
<span class="n">complied</span><span class="o">=</span><span class="kc">FALSE</span>
<span class="n">pwr.vs.cluster.sizeB</span><span class="o">=</span><span class="nf">function</span><span class="p">(</span><span class="n">icc</span><span class="p">){</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="w"> </span><span class="c1"># 10, 20, 50, 100 , the number of equal sized clusters</span>
<span class="w">    </span><span class="c1"># calculate the variance for cluster random effect. </span>
<span class="w">    </span><span class="n">icc</span><span class="o">=</span><span class="n">icc</span><span class="w"> </span><span class="c1">#k/(n.group1*2) # although maximum allowable icc for current number of clusters is k/n.group1</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">sigma_b</span><span class="o">=</span><span class="n">icc</span><span class="o">*</span><span class="n">sigma_e</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">icc</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">N</span><span class="o">=</span><span class="n">ni</span><span class="o">*</span><span class="m">2</span><span class="w"> </span><span class="c1">#total number of subject for the two treatment groups. </span>
<span class="w">    </span>
<span class="w">    </span><span class="c1"># Loop over to estimate power. </span>
<span class="w">    </span><span class="n">signif.ci</span><span class="o">=</span><span class="kc">NULL</span><span class="w"> </span><span class="c1"># significance by confidence interval. ideally, the conclusion should be the same (by duality of hypothesis test and ci) </span>
<span class="w">    </span>
<span class="w">    </span><span class="n">nsim</span><span class="o">=</span><span class="n">nsim</span>
<span class="w">    </span>
<span class="w">    </span><span class="nf">for </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nsim</span><span class="p">){</span>

<span class="w">               </span><span class="c1"># Randomize patients to treatment </span>
<span class="w">        </span><span class="n">trt</span><span class="o">=</span><span class="nf">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">prob</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>

<span class="w">        </span><span class="c1">## If assigning doctors to patients in a random fashion without conditioning on treatment assigned to</span>
<span class="w">        </span><span class="n">cluster.assigment</span><span class="o">=</span><span class="nf">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>

<span class="w">        </span><span class="c1">## Extract proportion of intervention for each doctor/cluster</span>
<span class="w">        </span><span class="n">cross.in.prop</span><span class="o">=</span><span class="nf">as.vector</span><span class="p">(</span><span class="w"> </span><span class="nf">prop.table</span><span class="p">(</span><span class="w"> </span><span class="nf">table</span><span class="p">(</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="p">),</span><span class="w"> </span><span class="n">margin</span><span class="o">=</span><span class="m">1</span><span class="p">)[,</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c1"># </span>

<span class="w">        </span><span class="c1">## Assign these proportions to doctors </span>
<span class="w">        </span><span class="n">interven.prop.vec</span><span class="o">=</span><span class="n">cross.in.prop</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="p">]</span>

<span class="w">        </span><span class="c1">## If proportion of controls with a doctor is &gt; 0.5, given all the patients </span>
<span class="w">        </span><span class="c1"># in that cluster intervention, otherwise keep the current treatment. </span>
<span class="w">        </span><span class="n">trt.contam</span><span class="o">=</span><span class="n">trt</span>
<span class="w">        </span><span class="n">trt.contam</span><span class="p">[</span><span class="n">interven.prop.vec</span><span class="o">&gt;</span><span class="n">tipping.point</span><span class="p">]</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="c1"># tipping point. </span>
<span class="w">        </span>
<span class="w">        </span><span class="c1"># Generate compliance variable </span>
<span class="w">        </span><span class="n">compliance</span><span class="o">=</span><span class="p">(</span><span class="n">trt.contam</span><span class="o">==</span><span class="n">trt</span><span class="p">)</span><span class="o">*</span><span class="m">1</span><span class="w"> </span><span class="c1"># complaince variance </span>


<span class="w">        </span><span class="c1"># # x-beta </span>
<span class="w">        </span><span class="n">xb</span><span class="o">=</span><span class="n">beta</span><span class="o">*</span><span class="n">trt.contam</span><span class="w"> </span><span class="c1"># make sure to use the treatment variable that acts behind the scene!</span>

<span class="w">        </span><span class="c1"># # simulate cluster random intercept (for now)  </span>
<span class="w">        </span><span class="n">clust.eff</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">sigma_b</span><span class="p">)</span><span class="w"> </span><span class="c1"># number of clusters is k</span>

<span class="w">        </span><span class="n">clust.eff.vec</span><span class="o">=</span><span class="n">clust.eff</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="p">]</span><span class="w"> </span><span class="c1"># assign each cluster to its random intercept </span>

<span class="w">        </span><span class="c1"># # generate outcome variable yijk using equation in model 1. </span>
<span class="w">        </span><span class="n">y</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">xb</span><span class="p">,</span><span class="w">  </span><span class="n">sigma_e</span><span class="p">)</span><span class="o">+</span><span class="n">clust.eff.vec</span>

<span class="w">        </span><span class="c1"># # combine into a dataframe </span>

<span class="w">        </span><span class="n">clust.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="o">=</span><span class="n">trt</span><span class="p">,</span><span class="w"> </span><span class="n">compliance</span><span class="o">=</span><span class="n">compliance</span><span class="p">,</span>
<span class="w">                            </span><span class="n">cluster.assigned</span><span class="o">=</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span><span class="n">cluster_random_interc</span><span class="o">=</span><span class="n">clust.eff.vec</span><span class="p">)</span><span class="w"> </span><span class="c1"># add icc, number of clusters at a later date. </span>

<span class="w">        </span><span class="nf">if</span><span class="p">(</span><span class="n">complied</span><span class="p">){</span>
<span class="w">        </span><span class="n">lm_mixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">suppressWarnings</span><span class="p">(</span><span class="w"> </span><span class="nf">suppressMessages</span><span class="p">(</span><span class="w"> </span><span class="nf">lmer</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">trt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">compliance</span><span class="o">+</span><span class="p">(</span><span class="m">1</span><span class="o">|</span><span class="w"> </span><span class="n">cluster.assigned</span><span class="p">),</span><span class="w"> </span>
<span class="w">                                                            </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clust.df</span><span class="p">,</span><span class="w"> </span>
<span class="w">                       </span><span class="n">control</span><span class="o">=</span><span class="nf">lmerControl</span><span class="p">(</span><span class="n">check.conv.singular</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">.makeCC</span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ignore&quot;</span><span class="p">,</span><span class="w">  </span>
<span class="w">                                                                         </span><span class="n">tol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1e-4</span><span class="p">))</span>
<span class="w">                       </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)}</span><span class="n">else</span><span class="p">{</span>
<span class="w">        </span>
<span class="w">       </span><span class="n">lm_mixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">suppressWarnings</span><span class="p">(</span><span class="w"> </span><span class="nf">suppressMessages</span><span class="p">(</span><span class="w"> </span><span class="nf">lmer</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">trt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="o">|</span><span class="w"> </span><span class="n">cluster.assigned</span><span class="p">),</span><span class="w"> </span>
<span class="w">                                                        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clust.df</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">control</span><span class="o">=</span><span class="nf">lmerControl</span><span class="p">(</span><span class="n">check.conv.singular</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">.makeCC</span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ignore&quot;</span><span class="p">,</span><span class="w">  </span>
<span class="w">                                                                     </span><span class="n">tol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1e-4</span><span class="p">))</span>
<span class="w">                   </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1"># Note that confint is a profile confidence interval. It is not a formal test. </span>
<span class="w">        </span><span class="c1"># So, it cannot be trusted</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">signif.ci</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nf">any</span><span class="p">(</span><span class="nf">suppressWarnings</span><span class="p">(</span><span class="nf">confint</span><span class="p">(</span><span class="nf">profile</span><span class="p">(</span><span class="n">lm_mixed</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;trt&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="o">&lt;=</span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="c1"># check if we reject the null. Here, check if CI includes zero. If it does, we fail to reject the null. </span>
<span class="w">        </span><span class="c1">#signif.ci[i]=any(suppressWarnings(confint(profile(lm_mixed.with.rand.slope), &#39;trt&#39;) )&lt;=0) </span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1"># The estimate power is close to the &#39;true&#39; power!</span>
<span class="w">    </span><span class="n">pwr.ci</span><span class="o">=</span><span class="m">1</span><span class="o">-</span><span class="nf">round</span><span class="p">(</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">signif.ci</span><span class="p">)</span><span class="o">/</span><span class="n">nsim</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="nf">return</span><span class="p">(</span><span class="n">pwr.ci</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span>
<span class="n">beta</span><span class="o">=</span><span class="m">0.2</span>
<span class="n">k</span><span class="o">=</span><span class="m">10</span>
<span class="n">contam.rate</span><span class="o">=</span><span class="m">0.0</span>
<span class="n">ni</span><span class="o">=</span><span class="nf">cont.sample.size</span><span class="p">(</span><span class="n">m1</span><span class="o">=</span><span class="m">9.0</span><span class="p">,</span>
<span class="w">                 </span><span class="n">m2</span><span class="o">=</span><span class="m">9.0</span><span class="o">+</span><span class="n">beta</span><span class="p">,</span>
<span class="w">                 </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_e</span><span class="p">,</span>
<span class="w">                 </span><span class="n">type_I_error</span><span class="o">=</span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span>
<span class="w">                 </span><span class="n">type_II_error</span><span class="o">=</span><span class="m">0.2</span><span class="p">)</span>

<span class="n">N</span><span class="o">=</span><span class="n">ni</span><span class="o">*</span><span class="m">2</span>
<span class="n">nsim</span><span class="o">=</span><span class="m">100</span>
<span class="n">tipping.point</span><span class="o">=</span><span class="m">0.5</span>
<span class="n">complied</span><span class="o">=</span><span class="kc">TRUE</span>
<span class="c1">#c(0, 0.01, 0.05, 0.1, 0.5)</span>
<span class="n">icc.mat</span><span class="o">=</span><span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">),</span><span class="w"> </span><span class="n">nrow</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="n">pwr.vs.iccB</span><span class="o">=</span><span class="nf">apply</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">icc.mat</span><span class="p">,</span><span class="n">MARGIN</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="o">=</span><span class="n">pwr.vs.cluster.sizeB</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">pwr.vs.iccB</span><span class="p">;</span><span class="w"> </span><span class="n">N</span>

<span class="c1"># adding complaince variable improves on power estimation. </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>0.64</li><li>0.66</li><li>0.74</li><li>0.66</li><li>0.49</li></ol>
</div><div class="output text_html">786</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">tipping.point.vec</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">0.6</span><span class="p">,</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w"> </span><span class="m">0.9</span><span class="p">)</span>
<span class="n">icc.mat</span><span class="o">=</span><span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">),</span><span class="w"> </span><span class="n">nrow</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="n">pwr.vs.icc.tipping.point.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">()</span><span class="w"> </span><span class="c1"># empty data frame. </span>

<span class="n">nsim</span><span class="o">=</span><span class="m">100</span>
<span class="n">ni</span><span class="o">=</span><span class="m">500</span><span class="w"> </span><span class="c1"># subjects per treatment group</span>
<span class="n">beta</span><span class="o">=</span><span class="m">0.2</span>
<span class="n">k</span><span class="o">=</span><span class="m">10</span>

<span class="nf">for </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">tipping.point.vec</span><span class="p">)){</span>
<span class="w">    </span><span class="n">tipping.point</span><span class="o">=</span><span class="n">tipping.point.vec</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="c1"># increasing cluster size</span>
<span class="w">    </span><span class="n">pwr.vs.iccB</span><span class="o">=</span><span class="nf">apply</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">icc.mat</span><span class="p">,</span><span class="n">MARGIN</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="o">=</span><span class="n">pwr.vs.cluster.sizeB</span><span class="p">)</span>
<span class="w">    </span><span class="n">temp</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">icc</span><span class="o">=</span><span class="n">icc.mat</span><span class="p">[</span><span class="m">1</span><span class="p">,],</span><span class="w"> </span><span class="n">pwr</span><span class="o">=</span><span class="n">pwr.vs.iccB</span><span class="p">,</span><span class="w"> </span><span class="n">tipping.point</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="n">tipping.point</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">pwr.vs.iccB</span><span class="p">)</span><span class="w"> </span><span class="p">))</span>
<span class="w">    </span><span class="n">pwr.vs.icc.tipping.point.df</span><span class="o">=</span><span class="nf">rbind</span><span class="p">(</span><span class="n">pwr.vs.icc.tipping.point.df</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w"> </span>

<span class="n">pwr.vs.icc.tipping.point.df</span><span class="o">$</span><span class="n">tipping.point</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">pwr.vs.icc.tipping.point.df</span><span class="o">$</span><span class="n">tipping.point</span><span class="p">)</span>

<span class="n">plot.tipping.point</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">pwr.vs.icc.tipping.point.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">icc</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">pwr</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">tipping.point</span><span class="p">)</span><span class="w">  </span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span>
<span class="w">    </span><span class="n">color</span><span class="o">=</span><span class="n">tipping.point</span>
<span class="p">),</span><span class="w"> </span><span class="n">lwd</span><span class="o">=</span><span class="m">1.0</span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_point</span><span class="p">()</span><span class="o">+</span><span class="nf">scale_color_brewer</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s">&quot;Dark2&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">ylim</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">)</span><span class="o">+</span>
<span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;icc&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s">&quot;power&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="c1">#face = &quot;bold&quot;, </span>
<span class="w">                            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&#39;power vs icc, sample size=&#39;</span><span class="p">,</span><span class="n">ni</span><span class="o">*</span><span class="m">2</span><span class="p">))</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span>

<span class="n">plot.tipping.point</span>

<span class="nf">ggsave</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="nf">paste0</span><span class="p">(</span><span class="n">tab_fig_path</span><span class="p">,</span><span class="s">&quot;power_vs_icc_by_tipping.point.svg&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">plot</span><span class="o">=</span><span class="n">plot.tipping.point</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="o">=</span><span class="m">5</span><span class="w"> </span><span class="p">)</span>
<span class="c1"># The statistical power is consistent with the true value for tipping points above 0.5. </span>
<span class="c1"># There is a significant power loss for low tipping points. </span>
<span class="c1"># Could adding compliance variable mitigate the power loss? </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3791dcc32a18c93604818d7b5726a544a30a25a965d627cf2a5b10d343ac52a0.png" src="_images/3791dcc32a18c93604818d7b5726a544a30a25a965d627cf2a5b10d343ac52a0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">tipping.point.vec</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">0.6</span><span class="p">,</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w"> </span><span class="m">0.9</span><span class="p">)</span>
<span class="n">icc.mat</span><span class="o">=</span><span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">),</span><span class="w"> </span><span class="n">nrow</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="n">pwr.vs.icc.tipping.point.dfB</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">()</span><span class="w"> </span><span class="c1"># empty data frame. </span>

<span class="n">nsim</span><span class="o">=</span><span class="m">100</span>
<span class="n">ni</span><span class="o">=</span><span class="m">500</span><span class="w"> </span><span class="c1"># subjects per treatment group</span>
<span class="n">beta</span><span class="o">=</span><span class="m">0.2</span>
<span class="n">k</span><span class="o">=</span><span class="m">10</span>
<span class="n">complied</span><span class="o">=</span><span class="kc">TRUE</span>

<span class="nf">for </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">tipping.point.vec</span><span class="p">)){</span>
<span class="w">    </span><span class="n">tipping.point</span><span class="o">=</span><span class="n">tipping.point.vec</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="c1"># increasing cluster size</span>
<span class="w">    </span><span class="n">pwr.vs.iccB</span><span class="o">=</span><span class="nf">apply</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">icc.mat</span><span class="p">,</span><span class="n">MARGIN</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="o">=</span><span class="n">pwr.vs.cluster.sizeB</span><span class="p">)</span>
<span class="w">    </span><span class="n">temp</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">icc</span><span class="o">=</span><span class="n">icc.mat</span><span class="p">[</span><span class="m">1</span><span class="p">,],</span><span class="w"> </span><span class="n">pwr</span><span class="o">=</span><span class="n">pwr.vs.iccB</span><span class="p">,</span><span class="w"> </span><span class="n">tipping.point</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="n">tipping.point</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">pwr.vs.iccB</span><span class="p">)</span><span class="w"> </span><span class="p">))</span>
<span class="w">    </span><span class="n">pwr.vs.icc.tipping.point.dfB</span><span class="o">=</span><span class="nf">rbind</span><span class="p">(</span><span class="n">pwr.vs.icc.tipping.point.dfB</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w"> </span>

<span class="n">pwr.vs.icc.tipping.point.dfB</span><span class="o">$</span><span class="n">tipping.point</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">pwr.vs.icc.tipping.point.dfB</span><span class="o">$</span><span class="n">tipping.point</span><span class="p">)</span>

<span class="n">plot.tipping.pointB</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">pwr.vs.icc.tipping.point.dfB</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">icc</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">pwr</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">tipping.point</span><span class="p">)</span><span class="w">  </span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span>
<span class="w">    </span><span class="n">color</span><span class="o">=</span><span class="n">tipping.point</span>
<span class="p">),</span><span class="w"> </span><span class="n">lwd</span><span class="o">=</span><span class="m">1.0</span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_point</span><span class="p">()</span><span class="o">+</span><span class="nf">scale_color_brewer</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s">&quot;Dark2&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">ylim</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">)</span><span class="o">+</span>
<span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;icc&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s">&quot;power&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="c1">#face = &quot;bold&quot;, </span>
<span class="w">                            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&#39;power vs icc, sample size=&#39;</span><span class="p">,</span><span class="n">ni</span><span class="o">*</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="s">&#39; compliance variable included&#39;</span><span class="p">))</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span>

<span class="n">plot.tipping.pointB</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a144351f28906d3a98d0676aa039238020e154aadc8119810e8f57ddbdd97317.png" src="_images/a144351f28906d3a98d0676aa039238020e154aadc8119810e8f57ddbdd97317.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">plot.tipping.pointAB</span><span class="o">=</span><span class="w"> </span><span class="nf">arrangeGrob</span><span class="p">(</span><span class="n">plot.tipping.point</span><span class="p">,</span><span class="n">plot.tipping.pointB</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1">#generates g</span>

<span class="nf">ggsave</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="nf">paste0</span><span class="p">(</span><span class="n">tab_fig_path</span><span class="p">,</span><span class="s">&quot;power_vs_icc_with_complaince_by_tipping_point.svg&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">plot</span><span class="o">=</span><span class="n">plot.tipping.pointAB</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="o">=</span><span class="m">5</span><span class="w"> </span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            name: "ir",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Elly Kipkogei
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>