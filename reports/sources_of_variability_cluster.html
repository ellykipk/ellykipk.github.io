

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>An attempt at reconciling the different notions of contamination in rct. &#8212; Contaminated RCT</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=365ca57ee442770a23c6"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'sources_of_variability_cluster';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
  
    <p class="title logo__title">Contaminated RCT</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="derive_cluster_sample_size_formula.html">Sample size calculation</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>An attempt at reconciling the different notions of contamination in rct.</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="an-attempt-at-reconciling-the-different-notions-of-contamination-in-rct">
<h1>An attempt at reconciling the different notions of contamination in rct.<a class="headerlink" href="#an-attempt-at-reconciling-the-different-notions-of-contamination-in-rct" title="Permalink to this heading">#</a></h1>
<p>Create a figure to demonstrate sources of variability when there is cluster.</p>
<p>Although, the sources of variability may not affect the estimated treatment effect. That is, the actual value is not affected. Instead, the variance component is affect and that in turn affects the type I and II errors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">tab_fig_path</span><span class="o">=</span><span class="s">&#39;/burg/biostats/users/ek3235/RCTcontamination/contamiation_in_rct/tables_and_figures/&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">source</span><span class="p">(</span><span class="s">&#39;utils.r&#39;</span><span class="p">)</span><span class="w"> </span><span class="c1"># heritable functions. Add plot functions later</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attaching package: ‘Matrix’


The following objects are masked from ‘package:tidyr’:

    expand, pack, unpack



Attaching package: ‘dplyr’


The following object is masked from ‘package:MASS’:

    select


The following object is masked from ‘package:gridExtra’:

    combine


The following objects are masked from ‘package:stats’:

    filter, lag


The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">g1_var</span><span class="o">=</span><span class="m">3</span>

<span class="n">g2_var</span><span class="o">=</span><span class="m">7</span>

<span class="n">g1g2_cov</span><span class="o">=</span><span class="m">1</span>

<span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">g1_var</span><span class="p">,</span><span class="w"> </span><span class="n">g1g2_cov</span><span class="p">,</span><span class="w"> </span><span class="n">g1g2_cov</span><span class="p">,</span><span class="w"> </span><span class="n">g2_var</span><span class="p">),</span><span class="w"> </span><span class="n">nrow</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>

<span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">,</span><span class="w"> </span><span class="m">0.01</span><span class="p">,</span><span class="w">  </span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">sigma_b</span><span class="o">/</span><span class="m">0.9</span><span class="p">),</span><span class="w"> </span><span class="n">nrow</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w"> </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A matrix: 2 × 2 of type dbl</caption>
<tbody>
	<tr><td>3</td><td>1</td></tr>
	<tr><td>1</td><td>7</td></tr>
</tbody>
</table>
</div><div class="output text_html"><table class="dataframe">
<caption>A matrix: 2 × 2 of type dbl</caption>
<tbody>
	<tr><td>0.001</td><td>0.010000000</td></tr>
	<tr><td>0.010</td><td>0.001111111</td></tr>
</tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">## Create a function to estimate beta-hat and take the mean of that.</span>
<span class="n">beta.hats.func</span><span class="o">=</span><span class="nf">function</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span>
<span class="w">                        </span><span class="n">N</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="m">10</span><span class="p">,</span>
<span class="w">                        </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span>
<span class="w">                        </span><span class="n">nsim</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span>
<span class="w">                        </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;random&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;control&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;cluster&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;complete&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;control.interact&#39;</span><span class="p">)){</span>

<span class="w">    </span><span class="n">cluster.type</span><span class="o">=</span><span class="nf">match.arg</span><span class="p">(</span><span class="n">cluster.assign.type</span><span class="p">)</span><span class="w"> </span><span class="c1"># check if cluster type matches what is expected. </span>
<span class="w">    </span>
<span class="w">    </span><span class="n">sigma_b</span><span class="o">=</span><span class="n">icc</span><span class="o">*</span><span class="n">sigma_e</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">icc</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">beta.est</span><span class="o">=</span><span class="kc">NULL</span>
<span class="w">    </span><span class="n">sig.ind</span><span class="o">=</span><span class="kc">NULL</span><span class="w"> </span><span class="c1"># check if significant or not. </span>
<span class="w">    </span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">cluster.type</span><span class="o">==</span><span class="s">&#39;random&#39;</span><span class="p">){</span>
<span class="w">        </span><span class="nf">for </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nsim</span><span class="p">){</span>
<span class="w">            </span><span class="c1"># Randomize patients to treatment</span>
<span class="w">            </span><span class="n">trt</span><span class="o">=</span><span class="nf">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">prob</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>

<span class="w">            </span><span class="c1">## If assigning doctors to patients in a random fashion without conditioning on treatment assigned to</span>
<span class="w">            </span><span class="n">cluster.assigment</span><span class="o">=</span><span class="nf">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>

<span class="w">            </span><span class="c1"># # x-beta </span>
<span class="w">            </span><span class="n">xb</span><span class="o">=</span><span class="n">beta</span><span class="o">*</span><span class="n">trt</span><span class="w"> </span><span class="c1"># make sure to use the treatment variable that acts behind the scene!</span>

<span class="w">            </span><span class="c1"># # simulate cluster random intercept (for now)  </span>
<span class="w">            </span><span class="n">clust.eff</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_b</span><span class="p">)</span><span class="w"> </span><span class="c1"># number of clusters is k</span>

<span class="w">            </span><span class="n">clust.eff.vec</span><span class="o">=</span><span class="n">clust.eff</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="p">]</span><span class="w"> </span><span class="c1"># assign each cluster to its random intercept </span>

<span class="w">            </span><span class="c1"># # generate outcome variable yijk using equation in model 1. </span>
<span class="w">            </span><span class="n">y</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">xb</span><span class="p">,</span><span class="w">  </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_e</span><span class="p">)</span><span class="o">+</span><span class="n">clust.eff.vec</span>

<span class="w">            </span><span class="n">clust.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="o">=</span><span class="n">trt</span><span class="p">,</span><span class="n">cluster.assigned</span><span class="o">=</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">cluster_random_interc</span><span class="o">=</span><span class="n">clust.eff.vec</span><span class="p">)</span><span class="w"> </span><span class="c1"># add icc, number of clusters at a later date. </span>
<span class="w">        </span>
<span class="w">            </span><span class="c1"># check if significant. </span>
<span class="w">            </span><span class="n">model1</span><span class="o">=</span><span class="nf">lm</span><span class="p">(</span><span class="n">y</span><span class="o">~</span><span class="n">trt</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">clust.df</span><span class="p">)</span>
<span class="w">            </span><span class="n">sig.ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="n">model1</span><span class="p">)</span><span class="o">$</span><span class="n">coeff</span><span class="p">[</span><span class="s">&#39;trt&#39;</span><span class="p">,</span><span class="s">&#39;Pr(&gt;|t|)&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="m">0.05</span>
<span class="w">            </span><span class="c1"># sig.ind[i]=t.test(y~trt, data=clust.df, var.equal=TRUE)$p.value&lt;0.05 # ignoring cluster assignment</span>
<span class="w">        </span>
<span class="w">            </span><span class="n">beta.est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">trt</span><span class="o">==</span><span class="m">1</span><span class="p">])</span><span class="o">-</span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">trt</span><span class="o">==</span><span class="m">0</span><span class="p">])}</span>
<span class="w">        </span>
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="n">else</span><span class="w"> </span><span class="nf">if </span><span class="p">(</span><span class="n">cluster.type</span><span class="o">==</span><span class="s">&#39;control&#39;</span><span class="p">){</span>
<span class="w">        </span><span class="c1"># Randomize patients to treatment </span>
<span class="w">        </span><span class="nf">for  </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nsim</span><span class="p">){</span>
<span class="w">            </span><span class="n">trt</span><span class="o">=</span><span class="nf">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">prob</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>

<span class="w">            </span><span class="n">trt</span><span class="o">=</span><span class="nf">sort</span><span class="p">(</span><span class="n">trt</span><span class="p">)</span><span class="w"> </span><span class="c1"># sort </span>
<span class="w">            </span><span class="n">ni</span><span class="o">=</span><span class="n">N</span><span class="o">/</span><span class="m">2</span>

<span class="w">            </span><span class="c1">## Assign to clusters in a controlled fashion. </span>
<span class="w">            </span><span class="n">cluster.assigment</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">each</span><span class="o">=</span><span class="n">ni</span><span class="o">/</span><span class="n">k</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">each</span><span class="o">=</span><span class="n">ni</span><span class="o">/</span><span class="n">k</span><span class="w"> </span><span class="p">))</span>

<span class="w">            </span><span class="c1"># # x-beta </span>
<span class="w">            </span><span class="n">xb</span><span class="o">=</span><span class="n">beta</span><span class="o">*</span><span class="n">trt</span><span class="w"> </span><span class="c1"># make sure to use the treatment variable that acts behind the scene!</span>

<span class="w">            </span><span class="c1"># # simulate cluster random intercept (for now)  </span>
<span class="w">            </span><span class="n">clust.eff</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_b</span><span class="p">)</span><span class="w"> </span><span class="c1"># number of clusters is k</span>

<span class="w">            </span><span class="n">clust.eff.vec</span><span class="o">=</span><span class="n">clust.eff</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="p">]</span><span class="w"> </span><span class="c1"># assign each cluster to its random intercept </span>

<span class="w">            </span><span class="c1"># # generate outcome variable yijk using equation in model 1. </span>
<span class="w">            </span><span class="n">y</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">xb</span><span class="p">,</span><span class="w">  </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_e</span><span class="p">)</span><span class="o">+</span><span class="n">clust.eff.vec</span>

<span class="w">            </span><span class="n">clust.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="o">=</span><span class="n">trt</span><span class="p">,</span><span class="n">cluster.assigned</span><span class="o">=</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">cluster_random_interc</span><span class="o">=</span><span class="n">clust.eff.vec</span><span class="p">)</span><span class="w"> </span><span class="c1"># add icc, number of clusters at a later date. </span>

<span class="w">            </span><span class="c1"># check if significant. </span>
<span class="w">            </span><span class="n">model1</span><span class="o">=</span><span class="nf">lm</span><span class="p">(</span><span class="n">y</span><span class="o">~</span><span class="n">trt</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">clust.df</span><span class="p">)</span>
<span class="w">            </span><span class="n">sig.ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="n">model1</span><span class="p">)</span><span class="o">$</span><span class="n">coeff</span><span class="p">[</span><span class="s">&#39;trt&#39;</span><span class="p">,</span><span class="s">&#39;Pr(&gt;|t|)&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="m">0.05</span>
<span class="w">    </span><span class="c1">#         sig.ind[i]=t.test(y~trt, data=clust.df, var.equal=TRUE)$p.value&lt;0.05 # ignoring cluster assignment</span>

<span class="w">            </span><span class="n">beta.est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">trt</span><span class="o">==</span><span class="m">1</span><span class="p">])</span><span class="o">-</span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">trt</span><span class="o">==</span><span class="m">0</span><span class="p">])}</span>
<span class="w">    </span>
<span class="w">    </span><span class="p">}</span><span class="n">else</span><span class="w"> </span><span class="nf">if </span><span class="p">(</span><span class="n">cluster.type</span><span class="o">==</span><span class="s">&#39;cluster&#39;</span><span class="p">){</span>
<span class="w">        </span><span class="c1"># Generate cluster id </span>
<span class="w">        </span><span class="nf">for </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nsim</span><span class="p">){</span>
<span class="w">            </span><span class="n">cluster.assigment</span><span class="o">=</span><span class="nf">sample</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>

<span class="w">            </span><span class="c1"># Randomize treatment to the k clusters. </span>
<span class="w">            </span><span class="n">trt.cluster</span><span class="o">=</span><span class="nf">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">prob</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>

<span class="w">            </span><span class="c1"># arrest cases where randomization to treatment results to all</span>
<span class="w">                </span><span class="c1">#clusters being randomized to the same treatment</span>
<span class="w">            </span><span class="nf">while</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="nf">table</span><span class="p">(</span><span class="n">trt.cluster</span><span class="p">))</span><span class="o">!=</span><span class="m">2</span><span class="p">){</span>
<span class="w">                </span><span class="n">trt.cluster</span><span class="o">=</span><span class="nf">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">prob</span><span class="o">=</span><span class="m">0.5</span><span class="p">)}</span>

<span class="w">            </span><span class="n">trt</span><span class="o">=</span><span class="n">trt.cluster</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="p">]</span><span class="w"> </span><span class="c1"># assign each cluster to its appropriate treatment. </span>

<span class="w">            </span><span class="n">xb</span><span class="o">=</span><span class="n">beta</span><span class="o">*</span><span class="n">trt</span>

<span class="w">            </span><span class="c1"># simulate cluster random intercept (for now)  </span>
<span class="w">            </span><span class="n">clust.eff</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_b</span><span class="p">)</span><span class="w"> </span><span class="c1"># number of clusters is k</span>

<span class="w">            </span><span class="n">clust.eff.vec</span><span class="o">=</span><span class="n">clust.eff</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="p">]</span><span class="w"> </span><span class="c1"># assign each cluster to its random intercept </span>

<span class="w">            </span><span class="c1"># generate outcome variable yijk using equation in model 1. </span>
<span class="w">            </span><span class="n">y</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">xb</span><span class="p">,</span><span class="w">  </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_e</span><span class="p">)</span><span class="o">+</span><span class="n">clust.eff.vec</span>

<span class="w">            </span><span class="n">clust.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="o">=</span><span class="n">trt</span><span class="p">,</span><span class="n">cluster.assigned</span><span class="o">=</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">cluster_random_interc</span><span class="o">=</span><span class="n">clust.eff.vec</span><span class="p">)</span><span class="w"> </span><span class="c1"># add icc, number of clusters at a later date. </span>
<span class="w">        </span>
<span class="w">            </span><span class="c1"># check if significant. </span>
<span class="w">            </span><span class="n">model1</span><span class="o">=</span><span class="nf">lm</span><span class="p">(</span><span class="n">y</span><span class="o">~</span><span class="n">trt</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">clust.df</span><span class="p">)</span>
<span class="w">            </span><span class="n">sig.ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="n">model1</span><span class="p">)</span><span class="o">$</span><span class="n">coeff</span><span class="p">[</span><span class="s">&#39;trt&#39;</span><span class="p">,</span><span class="s">&#39;Pr(&gt;|t|)&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="m">0.05</span>

<span class="w">            </span><span class="c1">#sig.ind[i]=t.test(y~trt, data=clust.df, var.equal=TRUE)$p.value&lt;0.05 # ignoring cluster assignment</span>

<span class="w">            </span><span class="n">beta.est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">trt</span><span class="o">==</span><span class="m">1</span><span class="p">])</span><span class="o">-</span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">trt</span><span class="o">==</span><span class="m">0</span><span class="p">])}</span>
<span class="w">    </span>
<span class="w">    </span><span class="p">}</span><span class="n">else</span><span class="w"> </span><span class="nf">if</span><span class="p">(</span><span class="n">cluster.type</span><span class="o">==</span><span class="s">&#39;complete&#39;</span><span class="p">){</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">## Assign to clusters using complete block design. Randomize within cluster, that is.  </span>
<span class="w">        </span><span class="nf">for </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nsim</span><span class="p">){</span>
<span class="w">            </span>
<span class="w">            </span><span class="n">cluster.assigment</span><span class="o">=</span><span class="nf">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>

<span class="w">            </span><span class="c1"># Randomize patients to treatment within each cluster </span>
<span class="w">            </span><span class="n">trt</span><span class="o">=</span><span class="kc">NULL</span>
<span class="w">            </span>
<span class="w">            </span><span class="n">count_freq.df</span><span class="o">=</span><span class="nf">as.data.frame</span><span class="p">(</span><span class="nf">table</span><span class="p">(</span><span class="n">cluster.assigment</span><span class="p">))</span><span class="w"> </span><span class="c1"># extract count and freq of selected clusters</span>
<span class="w">            </span><span class="n">cluster.count</span><span class="o">=</span><span class="n">count_freq.df</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="c1"># count </span>
<span class="w">            </span><span class="n">cluster.id</span><span class="o">=</span><span class="n">count_freq.df</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="c1"># cluster  id. some </span>
<span class="w">            </span><span class="c1">#clusters may not be selected by random chance</span>
<span class="w">            </span><span class="nf">for</span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">cluster.id</span><span class="p">)</span><span class="w"> </span><span class="p">){</span>
<span class="w">                </span><span class="n">trt</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="o">==</span><span class="n">cluster.id</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">=</span><span class="nf">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">cluster.count</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">prob</span><span class="o">=</span><span class="m">0.5</span><span class="p">)}</span>

<span class="w">            </span><span class="c1"># # x-beta </span>
<span class="w">            </span><span class="n">xb</span><span class="o">=</span><span class="n">beta</span><span class="o">*</span><span class="n">trt</span><span class="w"> </span><span class="c1"># make sure to use the treatment variable that acts behind the scene!</span>

<span class="w">            </span><span class="c1"># # simulate cluster random intercept (for now)  </span>
<span class="w">            </span><span class="n">clust.eff</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_b</span><span class="p">)</span><span class="w"> </span><span class="c1"># number of clusters is k</span>

<span class="w">            </span><span class="n">clust.eff.vec</span><span class="o">=</span><span class="n">clust.eff</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="p">]</span><span class="w"> </span><span class="c1"># assign each cluster to its random intercept </span>

<span class="w">            </span><span class="c1"># # generate outcome variable yijk using equation in model 1. </span>
<span class="w">            </span><span class="n">y</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">xb</span><span class="p">,</span><span class="w">  </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_e</span><span class="p">)</span><span class="o">+</span><span class="n">clust.eff.vec</span>

<span class="w">            </span><span class="n">clust.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="o">=</span><span class="n">trt</span><span class="p">,</span><span class="n">cluster.assigned</span><span class="o">=</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span>
<span class="w">                </span><span class="n">cluster_random_interc</span><span class="o">=</span><span class="n">clust.eff.vec</span><span class="p">)</span><span class="w"> </span><span class="c1"># add icc, number of clusters at a later date. </span>

<span class="w">            </span><span class="c1"># check if significant. </span>
<span class="w">            </span><span class="n">model1</span><span class="o">=</span><span class="nf">lm</span><span class="p">(</span><span class="n">y</span><span class="o">~</span><span class="n">trt</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">clust.df</span><span class="p">)</span>
<span class="w">            </span><span class="n">sig.ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="n">model1</span><span class="p">)</span><span class="o">$</span><span class="n">coeff</span><span class="p">[</span><span class="s">&#39;trt&#39;</span><span class="p">,</span><span class="s">&#39;Pr(&gt;|t|)&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="m">0.05</span>
<span class="w">    </span><span class="c1">#         sig.ind[i]=t.test(y~trt, data=clust.df, var.equal=TRUE)$p.value&lt;0.05 # ignoring cluster assignment</span>

<span class="w">            </span><span class="n">beta.est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">trt</span><span class="o">==</span><span class="m">1</span><span class="p">])</span><span class="o">-</span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">trt</span><span class="o">==</span><span class="m">0</span><span class="p">])}</span>
<span class="w">    </span><span class="p">}</span><span class="n">else</span><span class="p">{</span>
<span class="w">        </span><span class="c1"># Randomize patients to treatment then to clusters but include random slope interaction with treatment</span>
<span class="w">        </span><span class="nf">for  </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nsim</span><span class="p">){</span>
<span class="w">            </span><span class="n">trt</span><span class="o">=</span><span class="nf">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">prob</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>

<span class="w">            </span><span class="n">trt</span><span class="o">=</span><span class="nf">sort</span><span class="p">(</span><span class="n">trt</span><span class="p">)</span><span class="w"> </span><span class="c1"># sort </span>
<span class="w">            </span><span class="n">ni</span><span class="o">=</span><span class="n">N</span><span class="o">/</span><span class="m">2</span>

<span class="w">            </span><span class="c1">## Assign to clusters in a controlled fashion. </span>
<span class="w">            </span><span class="n">cluster.assigment</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">each</span><span class="o">=</span><span class="n">ni</span><span class="o">/</span><span class="n">k</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">each</span><span class="o">=</span><span class="n">ni</span><span class="o">/</span><span class="n">k</span><span class="w"> </span><span class="p">))</span>

<span class="w">            </span><span class="c1"># # x-beta </span>
<span class="w">            </span><span class="n">xb</span><span class="o">=</span><span class="n">beta</span><span class="o">*</span><span class="n">trt</span><span class="w"> </span><span class="c1"># make sure to use the treatment variable that acts behind the scene!</span>

<span class="w">          </span><span class="c1"># # simulate cluster random intercept + random slope. </span>
<span class="w">            </span><span class="n">varcov.mat</span><span class="o">=</span><span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">,</span><span class="w"> </span><span class="m">0.01</span><span class="p">,</span><span class="w">  </span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">sigma_b</span><span class="o">/</span><span class="m">0.9</span><span class="p">),</span><span class="w"> </span><span class="n">nrow</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="c1"># </span>
<span class="w">            </span><span class="n">clust.eff</span><span class="o">=</span><span class="nf">mvrnorm</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">),</span><span class="w"> </span><span class="n">varcov.mat</span><span class="p">)</span><span class="w"> </span><span class="c1">#rnorm(n=k, mean=0, sigma_b) # number of clusters is k</span>

<span class="w">            </span><span class="n">clust.eff.mat</span><span class="o">=</span><span class="n">clust.eff</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="c1"># assign each cluster to its random intercept </span>

<span class="w">            </span><span class="c1"># # # generate outcome variable yijk using equation in model 1. </span>
<span class="w">            </span><span class="n">y</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">xb</span><span class="p">,</span><span class="w">  </span><span class="n">sigma_e</span><span class="p">)</span><span class="o">+</span><span class="n">clust.eff.mat</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span><span class="o">+</span><span class="n">clust.eff.mat</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span><span class="o">*</span><span class="n">trt</span>

<span class="w">            </span><span class="c1"># # combine into a dataframe </span>
<span class="w">            </span><span class="n">cluster_random_eff</span><span class="o">=</span><span class="n">clust.eff.mat</span>
<span class="w">            </span><span class="nf">colnames</span><span class="p">(</span><span class="n">cluster_random_eff</span><span class="p">)</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;randm interc&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;randm slope&#39;</span><span class="p">)</span>
<span class="w">            </span><span class="n">clust.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="o">=</span><span class="n">trt</span><span class="p">,</span><span class="n">cluster.assigned</span><span class="o">=</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                </span><span class="n">cluster_random_eff</span><span class="p">)</span><span class="w"> </span><span class="c1"># add icc, number of clusters at a later date. </span>
<span class="w">    </span>
<span class="w">            </span><span class="c1"># check if significant. </span>
<span class="w">            </span><span class="n">model1</span><span class="o">=</span><span class="nf">lm</span><span class="p">(</span><span class="n">y</span><span class="o">~</span><span class="n">trt</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">clust.df</span><span class="p">)</span>
<span class="w">            </span><span class="n">sig.ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="n">model1</span><span class="p">)</span><span class="o">$</span><span class="n">coeff</span><span class="p">[</span><span class="s">&#39;trt&#39;</span><span class="p">,</span><span class="s">&#39;Pr(&gt;|t|)&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="m">0.05</span>
<span class="w">    </span><span class="c1">#         sig.ind[i]=t.test(y~trt, data=clust.df, var.equal=TRUE)$p.value&lt;0.05 # ignoring cluster assignment</span>

<span class="w">            </span><span class="n">beta.est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">trt</span><span class="o">==</span><span class="m">1</span><span class="p">])</span><span class="o">-</span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">trt</span><span class="o">==</span><span class="m">0</span><span class="p">])}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">pwr.est</span><span class="o">=</span><span class="nf">round</span><span class="p">(</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">sig.ind</span><span class="p">)</span><span class="o">/</span><span class="n">nsim</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<span class="w">    </span><span class="n">sim.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">beta.est</span><span class="p">,</span><span class="w"> </span><span class="n">est.power</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="n">pwr.est</span><span class="p">,</span><span class="w"> </span><span class="n">nsim</span><span class="p">))</span>
<span class="w">    </span><span class="nf">return</span><span class="p">(</span><span class="n">sim.df</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Suppose we have 10 doctors, icc=0 and we have access to 1000 patients.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate sample size for specitific type I and II errors and effect size. </span>
<span class="n">n.group1</span><span class="o">=</span><span class="nf">cont.sample.size</span><span class="p">(</span>
<span class="w">                </span><span class="n">m1</span><span class="o">=</span><span class="m">1.0</span><span class="p">,</span>
<span class="w">                </span><span class="n">m2</span><span class="o">=</span><span class="m">1.2</span><span class="p">,</span>
<span class="w">                </span><span class="n">sd</span><span class="o">=</span><span class="m">1</span><span class="p">,</span>
<span class="w">                </span><span class="n">type_I_error</span><span class="o">=</span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span>
<span class="w">                </span><span class="n">type_II_error</span><span class="o">=</span><span class="m">0.2</span><span class="p">)</span>

<span class="c1"># calculate power from fixed sample size </span>
<span class="c1"># pwr.func(n=n.group1, </span>
<span class="c1">#         m1=1.0,</span>
<span class="c1">#         m2=1.2,</span>
<span class="c1">#         sd=1,</span>
<span class="c1">#         type_I_error=0.05)</span>

<span class="n">k</span><span class="o">=</span><span class="m">10</span>
<span class="nf">cluster.pwr.func</span><span class="p">(</span>
<span class="w">    </span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="n">m</span><span class="o">=</span><span class="m">400</span><span class="o">/</span><span class="n">k</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="n">mu1</span><span class="o">=</span><span class="m">1.0</span><span class="p">,</span>
<span class="w">    </span><span class="n">mu2</span><span class="o">=</span><span class="m">1.2</span><span class="p">,</span>
<span class="w">    </span><span class="n">sd</span><span class="o">=</span><span class="m">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">icc</span><span class="o">=</span><span class="m">0.9</span><span class="p">,</span>
<span class="w">    </span><span class="n">type_I_error</span><span class="o">=</span><span class="m">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.0254614451150927</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">pwr.vs.cluster.size</span><span class="o">=</span><span class="kc">NULL</span>
<span class="n">seq.icc</span><span class="o">=</span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">length.out</span><span class="o">=</span><span class="m">100</span><span class="p">)</span>
<span class="nf">for </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">100</span><span class="p">){</span>
<span class="w">    </span><span class="n">pwr.vs.cluster.size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nf">cluster.pwr.func</span><span class="p">(</span>
<span class="w">    </span><span class="n">k</span><span class="o">=</span><span class="m">400</span><span class="o">/</span><span class="n">i</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="n">m</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="n">mu1</span><span class="o">=</span><span class="m">1.0</span><span class="p">,</span>
<span class="w">    </span><span class="n">mu2</span><span class="o">=</span><span class="m">1.2</span><span class="p">,</span>
<span class="w">    </span><span class="n">sd</span><span class="o">=</span><span class="m">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">icc</span><span class="o">=</span><span class="m">0.3</span><span class="p">,</span>
<span class="w">    </span><span class="n">type_I_error</span><span class="o">=</span><span class="m">0.05</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">pwr.vs.cluster.size</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="o">=</span><span class="s">&#39;power&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="o">=</span><span class="s">&#39;cluster size (m)&#39;</span><span class="p">)</span>
<span class="c1"># power decreases as cluster size increases for a fixed sample size. </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9e36db4905e750bd4e4158d74f755a2f9c5f86382cdeef5ad12c82cb365d5559.png" src="_images/9e36db4905e750bd4e4158d74f755a2f9c5f86382cdeef5ad12c82cb365d5559.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">N</span><span class="o">=</span><span class="m">400</span><span class="o">*</span><span class="m">2</span>
<span class="n">sim.df.random</span><span class="o">=</span><span class="nf">beta.hats.func</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="m">100</span><span class="p">,</span>
<span class="w">            </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="m">0.6</span><span class="p">,</span>
<span class="w">            </span><span class="n">nsim</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span>
<span class="w">            </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="s">&#39;random&#39;</span><span class="p">)</span>

<span class="n">sim.df.control</span><span class="o">=</span><span class="nf">beta.hats.func</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="m">100</span><span class="p">,</span>
<span class="w">            </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="m">0.6</span><span class="p">,</span>
<span class="w">            </span><span class="n">nsim</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span>
<span class="w">            </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="s">&#39;control&#39;</span><span class="p">)</span>

<span class="n">sim.df.cluster</span><span class="o">=</span><span class="nf">beta.hats.func</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="m">100</span><span class="p">,</span>
<span class="w">            </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="m">0.6</span><span class="p">,</span>
<span class="w">            </span><span class="n">nsim</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span>
<span class="w">            </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="s">&#39;cluster&#39;</span><span class="p">)</span>

<span class="n">sim.df.complete</span><span class="o">=</span><span class="nf">beta.hats.func</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="m">100</span><span class="p">,</span>
<span class="w">            </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="m">0.6</span><span class="p">,</span>
<span class="w">            </span><span class="n">nsim</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span>
<span class="w">            </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="s">&#39;complete&#39;</span><span class="p">)</span>


<span class="n">beta.est.random</span><span class="o">=</span><span class="n">sim.df.random</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span>

<span class="n">beta.est.control</span><span class="o">=</span><span class="n">sim.df.control</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span>

<span class="n">beta.est.cluster</span><span class="o">=</span><span class="n">sim.df.cluster</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span>

<span class="n">beta.est.complete</span><span class="o">=</span><span class="n">sim.df.complete</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span>

<span class="n">beta.est.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">beta.est.random</span><span class="p">,</span><span class="n">beta.est.control</span><span class="p">,</span><span class="w"> </span><span class="n">beta.est.cluster</span><span class="p">,</span><span class="w"> </span><span class="n">beta.est.complete</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span>
<span class="n">icc.from.tau</span><span class="o">=</span><span class="nf">function</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">){</span>
<span class="w">    </span><span class="nf">return</span><span class="p">(</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="w"> </span><span class="n">sigma_b</span><span class="o">/</span><span class="p">(</span><span class="n">sigma_b</span><span class="o">+</span><span class="n">sigma_e</span><span class="p">),</span><span class="w"> </span><span class="m">2</span><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="p">}</span>

<span class="n">sigma_b.vec</span><span class="o">=</span><span class="nf">matrix</span><span class="p">(</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">),</span><span class="w"> </span><span class="n">nrow</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="n">icc.vec</span><span class="o">=</span><span class="nf">apply</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">sigma_b.vec</span><span class="p">,</span><span class="w"> </span><span class="n">MARGIN</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="o">=</span><span class="n">icc.from.tau</span><span class="p">)</span>


<span class="n">pwr.icc</span><span class="o">=</span><span class="kc">NULL</span>

<span class="nf">for</span><span class="p">(</span><span class="n">ix</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">icc.vec</span><span class="p">)){</span>
<span class="w">    </span><span class="n">pwr.icc</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">=</span><span class="nf">beta.hats.func</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">N</span><span class="o">=</span><span class="m">800</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="m">100</span><span class="p">,</span>
<span class="w">            </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="n">icc.vec</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
<span class="w">            </span><span class="n">nsim</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span>
<span class="w">            </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="s">&#39;cluster&#39;</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">]}</span>
<span class="n">pwr.icc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>0.8</li><li>0.52</li><li>0.54</li><li>0.53</li></ol>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">sum</span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">8</span><span class="p">)</span><span class="w"> </span>

<span class="n">hist.random</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">beta.est.random</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="m">50</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="w"> </span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="s">&#39;indiv rand + random cluster assignment&#39;</span><span class="w">  </span><span class="p">)</span><span class="o">+</span>
<span class="nf">xlim</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">))</span><span class="o">+</span>
<span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">beta.est.df</span><span class="o">$</span><span class="n">beta.est.random</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="n">hist.control</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">beta.est.control</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="m">50</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="w"> </span><span class="p">)</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="s">&#39;indiv rand + controlled cluster assignment&#39;</span><span class="w"> </span><span class="p">)</span><span class="o">+</span>
<span class="nf">xlim</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">))</span><span class="o">+</span>
<span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">beta.est.df</span><span class="o">$</span><span class="n">beta.est.control</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="n">hist.cluster</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">beta.est.cluster</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="m">50</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="w"> </span><span class="p">)</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="s">&#39;cluster randomized to treatment&#39;</span><span class="w"> </span><span class="p">)</span><span class="o">+</span>
<span class="nf">xlim</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">))</span><span class="o">+</span>
<span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">beta.est.df</span><span class="o">$</span><span class="n">beta.est.cluster</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>


<span class="n">hist.complete</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">beta.est.complete</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="m">50</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="w"> </span><span class="p">)</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="s">&#39;treatment randomized within cluster&#39;</span><span class="w"> </span><span class="p">)</span><span class="o">+</span>
<span class="nf">xlim</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">))</span><span class="o">+</span>
<span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">beta.est.df</span><span class="o">$</span><span class="n">beta.est.complete</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="nf">grid.arrange</span><span class="p">(</span><span class="n">hist.random</span><span class="p">,</span><span class="n">hist.control</span><span class="p">,</span><span class="n">hist.cluster</span><span class="p">,</span><span class="n">hist.complete</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>

<span class="n">histogram.comparison</span><span class="o">=</span><span class="w"> </span><span class="nf">arrangeGrob</span><span class="p">(</span><span class="n">hist.random</span><span class="p">,</span><span class="n">hist.control</span><span class="p">,</span><span class="n">hist.cluster</span><span class="p">,</span><span class="n">hist.complete</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="c1">#generates g</span>
<span class="c1"># ggsave(file=paste0(tab_fig_path,&quot;beta_hat_estimate_by_clustering_type.svg&quot;), </span>
<span class="c1">#        plot=histogram.comparison, width=15, height=8 )</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6f4695727aa6ffc1732ffadc355c957a0314365002d5ddec820be99986b2130d.png" src="_images/6f4695727aa6ffc1732ffadc355c957a0314365002d5ddec820be99986b2130d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">pwr.est.random</span><span class="o">=</span><span class="n">sim.df.random</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span>

<span class="n">pwr.est.control</span><span class="o">=</span><span class="n">sim.df.control</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span>

<span class="n">pwr.est.cluster</span><span class="o">=</span><span class="n">sim.df.cluster</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span>

<span class="n">pwr.est.complete</span><span class="o">=</span><span class="n">sim.df.complete</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span>

<span class="n">pwr.est.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">pwr.est.random</span><span class="p">,</span><span class="n">pwr.est.control</span><span class="p">,</span><span class="w"> </span><span class="n">pwr.est.cluster</span><span class="p">,</span><span class="w"> </span><span class="n">pwr.est.complete</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">pwr.est.df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 6 × 4</caption>
<thead>
	<tr><th></th><th scope=col>pwr.est.random</th><th scope=col>pwr.est.control</th><th scope=col>pwr.est.cluster</th><th scope=col>pwr.est.complete</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>0.36</td><td>0.28</td><td>0.54</td><td>0.37</td></tr>
	<tr><th scope=row>2</th><td>0.36</td><td>0.28</td><td>0.54</td><td>0.37</td></tr>
	<tr><th scope=row>3</th><td>0.36</td><td>0.28</td><td>0.54</td><td>0.37</td></tr>
	<tr><th scope=row>4</th><td>0.36</td><td>0.28</td><td>0.54</td><td>0.37</td></tr>
	<tr><th scope=row>5</th><td>0.36</td><td>0.28</td><td>0.54</td><td>0.37</td></tr>
	<tr><th scope=row>6</th><td>0.36</td><td>0.28</td><td>0.54</td><td>0.37</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>We see that when icc=0, the variability of the estimated beta is considerably similar across the different approaches of cluster assignment.</p>
<p>Now suppose we have icc=0.5</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">sim.df.random</span><span class="o">=</span><span class="nf">beta.hats.func</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">N</span><span class="o">=</span><span class="m">800</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="m">100</span><span class="p">,</span>
<span class="w">            </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span>
<span class="w">            </span><span class="n">nsim</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span>
<span class="w">            </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="s">&#39;random&#39;</span><span class="p">)</span>

<span class="n">sim.df.control</span><span class="o">=</span><span class="nf">beta.hats.func</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">N</span><span class="o">=</span><span class="m">800</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="m">100</span><span class="p">,</span>
<span class="w">            </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span>
<span class="w">            </span><span class="n">nsim</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span>
<span class="w">            </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="s">&#39;control&#39;</span><span class="p">)</span>

<span class="n">sim.df.cluster</span><span class="o">=</span><span class="nf">beta.hats.func</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">N</span><span class="o">=</span><span class="m">800</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="m">100</span><span class="p">,</span>
<span class="w">            </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span>
<span class="w">            </span><span class="n">nsim</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span>
<span class="w">            </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="s">&#39;cluster&#39;</span><span class="p">)</span>

<span class="n">sim.df.complete</span><span class="o">=</span><span class="nf">beta.hats.func</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">N</span><span class="o">=</span><span class="m">800</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="m">100</span><span class="p">,</span>
<span class="w">            </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span>
<span class="w">            </span><span class="n">nsim</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span>
<span class="w">            </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="s">&#39;complete&#39;</span><span class="p">)</span>


<span class="n">beta.est.random</span><span class="o">=</span><span class="n">sim.df.random</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span>

<span class="n">beta.est.control</span><span class="o">=</span><span class="n">sim.df.control</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span>

<span class="n">beta.est.cluster</span><span class="o">=</span><span class="n">sim.df.cluster</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span>

<span class="n">beta.est.complete</span><span class="o">=</span><span class="n">sim.df.complete</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span>

<span class="n">beta.est.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">beta.est.random</span><span class="p">,</span><span class="n">beta.est.control</span><span class="p">,</span><span class="w"> </span><span class="n">beta.est.cluster</span><span class="p">,</span><span class="w"> </span><span class="n">beta.est.complete</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">8</span><span class="p">)</span><span class="w"> </span>

<span class="n">hist.random</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">beta.est.random</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="m">50</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="w"> </span><span class="p">)</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="s">&#39;indiv rand + random cluster assignment&#39;</span><span class="w">  </span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">beta.est.df</span><span class="o">$</span><span class="n">beta.est.random</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="n">hist.control</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">beta.est.control</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="m">50</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="w"> </span><span class="p">)</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="s">&#39;indiv rand + controlled cluster assignment&#39;</span><span class="w"> </span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">beta.est.df</span><span class="o">$</span><span class="n">beta.est.control</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="n">hist.cluster</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">beta.est.cluster</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="m">50</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="w"> </span><span class="p">)</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="s">&#39;cluster randomized to treatment&#39;</span><span class="w"> </span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">beta.est.df</span><span class="o">$</span><span class="n">beta.est.cluster</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>


<span class="n">hist.complete</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">beta.est.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">beta.est.complete</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="m">50</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="w"> </span><span class="p">)</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="s">&#39;treatment randomized within cluster&#39;</span><span class="w"> </span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">beta.est.df</span><span class="o">$</span><span class="n">beta.est.complete</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="nf">grid.arrange</span><span class="p">(</span><span class="n">hist.random</span><span class="p">,</span><span class="n">hist.control</span><span class="p">,</span><span class="n">hist.cluster</span><span class="p">,</span><span class="n">hist.complete</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2492fd68c354ef7c9d96436e1524338a82ba527c5673fed30ff8ea80a6bb3073.png" src="_images/2492fd68c354ef7c9d96436e1524338a82ba527c5673fed30ff8ea80a6bb3073.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">pwr.est.random</span><span class="o">=</span><span class="n">sim.df.random</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span>

<span class="n">pwr.est.control</span><span class="o">=</span><span class="n">sim.df.control</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span>

<span class="n">pwr.est.cluster</span><span class="o">=</span><span class="n">sim.df.cluster</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span>

<span class="n">pwr.est.complete</span><span class="o">=</span><span class="n">sim.df.complete</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span>

<span class="n">pwr.est.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">pwr.est.random</span><span class="p">,</span><span class="n">pwr.est.control</span><span class="p">,</span><span class="w"> </span><span class="n">pwr.est.cluster</span><span class="p">,</span><span class="w"> </span><span class="n">pwr.est.complete</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">pwr.est.df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 6 × 4</caption>
<thead>
	<tr><th></th><th scope=col>pwr.est.random</th><th scope=col>pwr.est.control</th><th scope=col>pwr.est.cluster</th><th scope=col>pwr.est.complete</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>0.5</td><td>0.52</td><td>0.54</td><td>0.54</td></tr>
	<tr><th scope=row>2</th><td>0.5</td><td>0.52</td><td>0.54</td><td>0.54</td></tr>
	<tr><th scope=row>3</th><td>0.5</td><td>0.52</td><td>0.54</td><td>0.54</td></tr>
	<tr><th scope=row>4</th><td>0.5</td><td>0.52</td><td>0.54</td><td>0.54</td></tr>
	<tr><th scope=row>5</th><td>0.5</td><td>0.52</td><td>0.54</td><td>0.54</td></tr>
	<tr><th scope=row>6</th><td>0.5</td><td>0.52</td><td>0.54</td><td>0.54</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>We now see that the estimates from cluster randomization is highly variable. And that is expected since icc between observations is very high which translates to high variance between clusters.</p>
<p>The other approaches remain similar in their variability.</p>
<p>And as expected, all <span class="math notranslate nohighlight">\(\beta\)</span> estimates are unbiased.</p>
<p><span class="math notranslate nohighlight">\(\textbf{1. Randomize to treatment then assign to doctors in a random fashion.}\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate data following the stragey above. It reflects the settings in UTI data from Min. </span>

<span class="nf">options</span><span class="p">(</span><span class="n">scipen</span><span class="o">=</span><span class="m">999</span><span class="p">)</span>
<span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="w"> </span><span class="c1"># treatment effect. </span>
<span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span>
<span class="c1"># calculate the required sample size for cluster randomization. Suppose that we have a fixed number of clusters and that there are equal number of subjects within each cluster. </span>
<span class="n">n.group1</span><span class="o">=</span><span class="nf">cont.sample.size</span><span class="p">(</span><span class="n">m1</span><span class="o">=</span><span class="m">9.0</span><span class="p">,</span>
<span class="w">                 </span><span class="n">m2</span><span class="o">=</span><span class="m">9.0</span><span class="o">+</span><span class="n">beta</span><span class="p">,</span>
<span class="w">                 </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_e</span><span class="p">,</span>
<span class="w">                 </span><span class="n">type_I_error</span><span class="o">=</span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span>
<span class="w">                 </span><span class="n">type_II_error</span><span class="o">=</span><span class="m">0.2</span><span class="p">)</span>


<span class="n">k</span><span class="o">=</span><span class="m">10</span><span class="w"> </span><span class="c1"># 10, 20, 50, 100 , the number of equal sized clusters</span>
<span class="n">ni</span><span class="o">=</span><span class="m">500</span><span class="w"> </span><span class="c1"># a fixed number of subjects per treatment group</span>
<span class="n">N</span><span class="o">=</span><span class="n">ni</span><span class="o">*</span><span class="m">2</span><span class="w"> </span><span class="c1"># total number of patients in the trial. </span>

<span class="c1"># calculate the variance for cluster random effect. </span>
<span class="n">icc</span><span class="o">=</span><span class="m">0.5</span><span class="w">   </span><span class="c1">#k/(n.group1) # maximum allowable icc for the current number of clusters is  k/n.group1</span>

<span class="n">sigma_b</span><span class="o">=</span><span class="n">icc</span><span class="o">*</span><span class="n">sigma_e</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">icc</span><span class="p">)</span>


<span class="c1"># Randomize patients to treatment </span>
<span class="n">trt</span><span class="o">=</span><span class="nf">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">prob</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>

<span class="c1">## If assigning doctors to patients in a random fashion without conditioning on treatment assigned to</span>
<span class="n">cluster.assigment</span><span class="o">=</span><span class="nf">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>

<span class="c1"># # x-beta </span>
<span class="n">xb</span><span class="o">=</span><span class="n">beta</span><span class="o">*</span><span class="n">trt</span><span class="w"> </span><span class="c1"># make sure to use the treatment variable that acts behind the scene!</span>

<span class="c1"># # simulate cluster random intercept (for now)  </span>
<span class="n">clust.eff</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">sigma_b</span><span class="p">)</span><span class="w"> </span><span class="c1"># number of clusters is k</span>

<span class="n">clust.eff.vec</span><span class="o">=</span><span class="n">clust.eff</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="p">]</span><span class="w"> </span><span class="c1"># assign each cluster to its random intercept </span>

<span class="c1"># # generate outcome variable yijk using equation in model 1. </span>
<span class="n">y</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">xb</span><span class="p">,</span><span class="w">  </span><span class="n">sigma_e</span><span class="p">)</span><span class="o">+</span><span class="n">clust.eff.vec</span>

<span class="c1"># # combine into a dataframe </span>

<span class="n">clust.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="o">=</span><span class="n">trt</span><span class="p">,</span><span class="n">cluster.assigned</span><span class="o">=</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">cluster_random_interc</span><span class="o">=</span><span class="n">clust.eff.vec</span><span class="p">)</span><span class="w"> </span><span class="c1"># add icc, number of clusters at a later date. </span>


<span class="nf">head</span><span class="p">(</span><span class="n">clust.df</span><span class="p">)</span>

<span class="c1"># sanity checks </span>
<span class="nf">table</span><span class="p">(</span><span class="w"> </span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 6 × 4</caption>
<thead>
	<tr><th></th><th scope=col>y</th><th scope=col>trt</th><th scope=col>cluster.assigned</th><th scope=col>cluster_random_interc</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td> 0.9569542</td><td>1</td><td>5</td><td>-0.1923395</td></tr>
	<tr><th scope=row>2</th><td> 1.6210919</td><td>1</td><td>4</td><td> 0.9819804</td></tr>
	<tr><th scope=row>3</th><td> 0.1230638</td><td>1</td><td>2</td><td> 0.7359871</td></tr>
	<tr><th scope=row>4</th><td> 1.9102954</td><td>0</td><td>3</td><td> 1.5442268</td></tr>
	<tr><th scope=row>5</th><td>-2.8938740</td><td>0</td><td>1</td><td>-1.3838635</td></tr>
	<tr><th scope=row>6</th><td>-1.4921075</td><td>0</td><td>9</td><td>-1.5457266</td></tr>
</tbody>
</table>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                 trt
cluster.assigment  0  1
               1  50 44
               2  41 61
               3  49 31
               4  53 46
               5  55 51
               6  42 56
               7  49 48
               8  52 37
               9  63 63
               10 53 56
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">clust.df</span><span class="o">$</span><span class="n">cluster.assigned</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">cluster.assigned</span><span class="p">)</span>
<span class="n">clust.df</span><span class="o">$</span><span class="n">group</span><span class="o">=</span><span class="nf">ifelse</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">trt</span><span class="o">==</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;intervention&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;control&#39;</span><span class="p">)</span>

<span class="w">                       </span>
<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w"> </span>

<span class="n">plot.overall</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">clust.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cluster.assigned</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span><span class="w">  </span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">group</span><span class="p">))</span><span class="o">+</span><span class="nf">scale_color_brewer</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s">&quot;Dark2&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">ylim</span><span class="p">(</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">))</span><span class="o">+</span>
<span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;Doctor&#39;s ID&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="c1">#face = &quot;bold&quot;, </span>
<span class="w">                            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">),</span><span class="w"> </span>
<span class="w">     </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="w"> </span><span class="p">)</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span>

<span class="n">plot.overall</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/147c783ee9ff3f8458c4c93535f3285bde269eb5ec0f22788388ee72dffbeab0.png" src="_images/147c783ee9ff3f8458c4c93535f3285bde269eb5ec0f22788388ee72dffbeab0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w"> </span>
<span class="n">box.random</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">clust.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cluster.assigned</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">group</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;Doctor&#39;s ID&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_boxplot</span><span class="p">()</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span>

<span class="n">box.random</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/112c205cc12aa1ff7a01933fd4e9444e319458e10f6631316a440075f9d0a130.png" src="_images/112c205cc12aa1ff7a01933fd4e9444e319458e10f6631316a440075f9d0a130.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># check if intervention is different from control if we ignore cluster variable. </span>
<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w"> </span>
<span class="n">box.overall</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">clust.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">group</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_boxplot</span><span class="p">()</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span><span class="o">+</span>
<span class="nf">ylab</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">[</span><span class="n">clust.df</span><span class="o">$</span><span class="n">trt</span><span class="o">==</span><span class="m">0</span><span class="p">]</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="n">box.overall</span>


<span class="n">box.cluster.overall</span><span class="o">=</span><span class="w"> </span><span class="nf">arrangeGrob</span><span class="p">(</span><span class="n">box.random</span><span class="p">,</span><span class="n">box.overall</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1">#generates g</span>
<span class="nf">ggsave</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="nf">paste0</span><span class="p">(</span><span class="n">tab_fig_path</span><span class="p">,</span><span class="s">&quot;sources_of_variability_cluster.svg&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">       </span><span class="n">plot</span><span class="o">=</span><span class="n">box.cluster.overall</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="m">18</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="o">=</span><span class="m">5</span><span class="w"> </span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d298d66213f13ed21ee499086d33b80d7726f11c0403121ceaae0536b42adc5a.png" src="_images/d298d66213f13ed21ee499086d33b80d7726f11c0403121ceaae0536b42adc5a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># # plot outcome by doctor for each treatment group. </span>

<span class="c1"># clust.df.interv=clust.df[clust.df$trt==1, ]                         </span>
<span class="c1"># options(repr.plot.width = 12, repr.plot.height =10) </span>

<span class="c1"># plot.interv=ggplot(clust.df.interv, aes(x=cluster.assigned, y=y, group=group)  )+</span>
<span class="c1"># geom_point(color=&#39;chocolate&#39;)+scale_color_brewer(palette=&quot;Dark2&quot;)+</span>
<span class="c1"># ylim( min(clust.df$y), max(clust.df$y))+</span>
<span class="c1"># labs(x=&quot; &quot;,y=&quot;outcome&quot;)+</span>
<span class="c1"># theme(axis.text.x = element_text(#face = &quot;bold&quot;, </span>
<span class="c1">#                             color =&quot;black&quot;, </span>
<span class="c1">#                            size = 15, angle = 0), </span>
<span class="c1">#      axis.text.y = element_text(color =&quot;black&quot;, </span>
<span class="c1">#                            size = 15,))+</span>
<span class="c1"># ggtitle( &#39;intervention group&#39; )+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),</span>
<span class="c1"># panel.background = element_blank(), axis.line = element_line(colour = &quot;black&quot;))</span>



<span class="c1"># # Control group </span>

<span class="c1"># clust.df.control=clust.df[clust.df$trt==0, ]                        </span>

<span class="c1"># plot.control=ggplot(clust.df.control, aes(x=cluster.assigned, y=y, group=group)  )+</span>
<span class="c1"># geom_point(color=&#39;blue&#39; )+scale_color_brewer(palette=&quot;Dark2&quot;)+</span>
<span class="c1"># ylim( min(clust.df$y), max(clust.df$y))+</span>
<span class="c1"># labs(x=&quot;Doctor&#39;s ID&quot;,y=&quot;outcome&quot;)+</span>
<span class="c1"># theme(axis.text.x = element_text(#face = &quot;bold&quot;, </span>
<span class="c1">#                             color =&quot;black&quot;, </span>
<span class="c1">#                            size = 15, angle = 0), </span>
<span class="c1">#      axis.text.y = element_text(color =&quot;black&quot;, </span>
<span class="c1">#                            size = 15,))+</span>
<span class="c1"># ggtitle( &#39;control group&#39; )+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),</span>
<span class="c1"># panel.background = element_blank(), axis.line = element_line(colour = &quot;black&quot;))</span>


<span class="c1"># grid.arrange(plot.interv,plot.control, ncol=1)</span>
</pre></div>
</div>
</div>
</div>
<p><span class="math notranslate nohighlight">\(\textbf{Findings}\)</span></p>
<p>We see that there is little to no variation in outcome between intervention and control group for a
specific doctor. That means outcome between intervention and control are highly correlated for the same doctor.</p>
<p>It is likely that cluster assignment after treatment randomization does not affect the <strong>estimation of the treatment effect value</strong>. Instead, it appears that it only affects whether we decide it is significant or not through its <strong>effect on the variance</strong>. So, the estimand is not affected, the statistical test of the estimand is the one that is affected.</p>
<p>Now, if this is true, then where is the ‘contamination’ problem coming from as Min argues?</p>
<p>If we are to rely heavily on the actual definition of contamination, then Min’s model does not apply.</p>
<p><span class="math notranslate nohighlight">\(\textbf{2. Randomize to treatment then assign to doctors in a controlled fashion}\)</span></p>
<p>That is, randomize such that each doctor gets equal number of intervetion and control patients.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Randomize to treatment but assign to clusters in a controlled manner as described above</span>

<span class="nf">options</span><span class="p">(</span><span class="n">scipen</span><span class="o">=</span><span class="m">999</span><span class="p">)</span>
<span class="n">beta</span><span class="o">=</span><span class="m">0.4</span><span class="w"> </span><span class="c1"># treatment effect. </span>
<span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span>
<span class="c1"># calculate the required sample size for cluster randomization. Suppose that we have a fixed number of clusters and that there are equal number of subjects within each cluster. </span>
<span class="n">n.group1</span><span class="o">=</span><span class="nf">cont.sample.size</span><span class="p">(</span><span class="n">m1</span><span class="o">=</span><span class="m">9.0</span><span class="p">,</span>
<span class="w">                 </span><span class="n">m2</span><span class="o">=</span><span class="m">9.0</span><span class="o">+</span><span class="n">beta</span><span class="p">,</span>
<span class="w">                 </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_e</span><span class="p">,</span>
<span class="w">                 </span><span class="n">type_I_error</span><span class="o">=</span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span>
<span class="w">                 </span><span class="n">type_II_error</span><span class="o">=</span><span class="m">0.2</span><span class="p">)</span>


<span class="n">k</span><span class="o">=</span><span class="m">10</span><span class="w"> </span><span class="c1"># 10, 20, 50, 100 , the number of equal sized clusters</span>
<span class="n">ni</span><span class="o">=</span><span class="m">500</span><span class="w"> </span><span class="c1"># a fixed number of subjects per treatment group</span>
<span class="n">N</span><span class="o">=</span><span class="n">ni</span><span class="o">*</span><span class="m">2</span><span class="w"> </span><span class="c1"># total number of patients in the trial. </span>

<span class="c1"># calculate the variance for cluster random effect. </span>
<span class="n">icc</span><span class="o">=</span><span class="m">0.5</span><span class="w">   </span><span class="c1">#k/(n.group1) # maximum allowable icc for the current number of clusters is  k/n.group1</span>

<span class="n">sigma_b</span><span class="o">=</span><span class="n">icc</span><span class="o">*</span><span class="n">sigma_e</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">icc</span><span class="p">)</span>


<span class="c1"># Randomize patients to treatment </span>
<span class="n">trt</span><span class="o">=</span><span class="nf">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">prob</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>

<span class="n">trt</span><span class="o">=</span><span class="nf">sort</span><span class="p">(</span><span class="n">trt</span><span class="p">)</span><span class="w"> </span><span class="c1"># sort </span>

<span class="c1">## Assign to clusters in a controlled fashion. </span>
<span class="n">cluster.assigment</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">each</span><span class="o">=</span><span class="n">ni</span><span class="o">/</span><span class="n">k</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">each</span><span class="o">=</span><span class="n">ni</span><span class="o">/</span><span class="n">k</span><span class="w"> </span><span class="p">))</span>

<span class="c1"># # x-beta </span>
<span class="n">xb</span><span class="o">=</span><span class="n">beta</span><span class="o">*</span><span class="n">trt</span><span class="w"> </span><span class="c1"># make sure to use the treatment variable that acts behind the scene!</span>

<span class="c1"># # simulate cluster random intercept (for now)  </span>
<span class="n">clust.eff</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">sigma_b</span><span class="p">)</span><span class="w"> </span><span class="c1"># number of clusters is k</span>

<span class="n">clust.eff.vec</span><span class="o">=</span><span class="n">clust.eff</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="p">]</span><span class="w"> </span><span class="c1"># assign each cluster to its random intercept </span>

<span class="c1"># # generate outcome variable yijk using equation in model 1. </span>
<span class="n">y</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">xb</span><span class="p">,</span><span class="w">  </span><span class="n">sigma_e</span><span class="p">)</span><span class="o">+</span><span class="n">clust.eff.vec</span>

<span class="c1"># # combine into a dataframe </span>

<span class="n">clust.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="o">=</span><span class="n">trt</span><span class="p">,</span><span class="n">cluster.assigned</span><span class="o">=</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">cluster_random_interc</span><span class="o">=</span><span class="n">clust.eff.vec</span><span class="p">)</span><span class="w"> </span><span class="c1"># add icc, number of clusters at a later date. </span>

<span class="nf">head</span><span class="p">(</span><span class="n">clust.df</span><span class="p">)</span>

<span class="c1"># sanity checks</span>
<span class="nf">table</span><span class="p">(</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 6 × 4</caption>
<thead>
	<tr><th></th><th scope=col>y</th><th scope=col>trt</th><th scope=col>cluster.assigned</th><th scope=col>cluster_random_interc</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td> 1.6703688</td><td>0</td><td>1</td><td>1.134879</td></tr>
	<tr><th scope=row>2</th><td> 1.7444219</td><td>0</td><td>1</td><td>1.134879</td></tr>
	<tr><th scope=row>3</th><td>-0.9757606</td><td>0</td><td>1</td><td>1.134879</td></tr>
	<tr><th scope=row>4</th><td> 2.4115903</td><td>0</td><td>1</td><td>1.134879</td></tr>
	<tr><th scope=row>5</th><td> 1.8521685</td><td>0</td><td>1</td><td>1.134879</td></tr>
	<tr><th scope=row>6</th><td> 2.2149179</td><td>0</td><td>1</td><td>1.134879</td></tr>
</tbody>
</table>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                 trt
cluster.assigment  0  1
               1  50 50
               2  50 50
               3  50 50
               4  50 50
               5  50 50
               6  50 50
               7  50 50
               8  50 50
               9  50 50
               10 50 50
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">clust.df</span><span class="o">$</span><span class="n">cluster.assigned</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">cluster.assigned</span><span class="p">)</span>
<span class="n">clust.df</span><span class="o">$</span><span class="n">group</span><span class="o">=</span><span class="nf">ifelse</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">trt</span><span class="o">==</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;intervention&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;control&#39;</span><span class="p">)</span>
<span class="w">                      </span>
<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w"> </span>

<span class="n">plot.overall</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">clust.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cluster.assigned</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span><span class="w">  </span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">group</span><span class="p">))</span><span class="o">+</span><span class="nf">scale_color_brewer</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s">&quot;Dark2&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">ylim</span><span class="p">(</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">))</span><span class="o">+</span>
<span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;Doctor&#39;s ID&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s">&quot;Outcome&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="c1">#face = &quot;bold&quot;, </span>
<span class="w">                            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">),</span><span class="w"> </span>
<span class="w">     </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="w"> </span><span class="p">)</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span>

<span class="n">plot.overall</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/07a3274c562763e60356601438ebb575ab620c87b7b2021d3eec1ad70092f6f9.png" src="_images/07a3274c562763e60356601438ebb575ab620c87b7b2021d3eec1ad70092f6f9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># check if intervention is different from control if we ignore cluster variable. </span>
<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w"> </span>
<span class="n">box.p</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">clust.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">group</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_boxplot</span><span class="p">()</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span><span class="o">+</span>
<span class="nf">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">[</span><span class="n">clust.df</span><span class="o">$</span><span class="n">trt</span><span class="o">==</span><span class="m">0</span><span class="p">]</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="n">box.p</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9ed234b491cdc9d2b4088af0c8febe0de0fefa7e140aca6e661922788e8e9a8d.png" src="_images/9ed234b491cdc9d2b4088af0c8febe0de0fefa7e140aca6e661922788e8e9a8d.png" />
</div>
</div>
<p><span class="math notranslate nohighlight">\(\textbf{Findings}\)</span></p>
<p>Again, the estimated treatment effect is not affected under this ‘factorial  design’ way of assigning patients to clusters. It only affects its variance.</p>
<p>It is also clear that there is doctor’s effect that can be captured via a random intercept. But there is no interaction between a doctor and the treatment variable. So, there is no need for the random slope. Of course this is expected because of the structure of the data-generating model.</p>
<p><span class="math notranslate nohighlight">\(\textbf{3. Randomize clusters to treatments}\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Conduct cluster randomization and generate the correspond data according to model 1</span>
<span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="w"> </span><span class="c1"># treatment effect. </span>
<span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span>
<span class="c1"># calculate the required sample size for cluster randomization. Suppose that we have a fixed number of clusters and that there are equal number of subjects within each cluster. </span>
<span class="n">n.group1</span><span class="o">=</span><span class="nf">cont.sample.size</span><span class="p">(</span><span class="n">m1</span><span class="o">=</span><span class="m">9.0</span><span class="p">,</span>
<span class="w">                 </span><span class="n">m2</span><span class="o">=</span><span class="m">9.0</span><span class="o">+</span><span class="n">beta</span><span class="p">,</span>
<span class="w">                 </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_e</span><span class="p">,</span>
<span class="w">                 </span><span class="n">type_I_error</span><span class="o">=</span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span>
<span class="w">                 </span><span class="n">type_II_error</span><span class="o">=</span><span class="m">0.2</span><span class="p">)</span>

<span class="n">k</span><span class="o">=</span><span class="m">10</span><span class="w"> </span><span class="c1"># 10, 20, 50, 100 , the number of equal sized clusters</span>
<span class="n">ni</span><span class="o">=</span><span class="m">500</span><span class="w"> </span><span class="c1"># a fixed number of subjects per treatment group</span>
<span class="n">N</span><span class="o">=</span><span class="n">ni</span><span class="o">*</span><span class="m">2</span><span class="w"> </span><span class="c1"># total number of patients in the trial. </span>

<span class="c1"># calculate the variance for cluster random effect. </span>
<span class="n">icc</span><span class="o">=</span><span class="m">0.9</span><span class="w">   </span><span class="c1">#k/(n.group1) # maximum allowable icc for the current number of clusters is  k/n.group1</span>
<span class="n">sigma_b</span><span class="o">=</span><span class="n">icc</span><span class="o">*</span><span class="n">sigma_e</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">icc</span><span class="p">)</span>

<span class="n">N</span><span class="o">=</span><span class="n">ni</span><span class="o">*</span><span class="m">2</span>

<span class="c1"># Generate cluster id </span>
<span class="n">cluster_id</span><span class="o">=</span><span class="nf">sample</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>

<span class="c1"># Randomize treatment to the k clusters. </span>
<span class="n">trt.cluster</span><span class="o">=</span><span class="nf">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">prob</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span>

<span class="n">trt</span><span class="o">=</span><span class="n">trt.cluster</span><span class="p">[</span><span class="n">cluster_id</span><span class="p">]</span><span class="w"> </span><span class="c1"># assign each cluster to its appropriate treatment. </span>

<span class="n">xb</span><span class="o">=</span><span class="n">beta</span><span class="o">*</span><span class="n">trt</span>

<span class="c1"># simulate cluster random intercept (for now)  </span>
<span class="n">clust.eff</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">sigma_b</span><span class="p">)</span><span class="w"> </span><span class="c1"># number of clusters is k</span>

<span class="n">clust.vec</span><span class="o">=</span><span class="n">clust.eff</span><span class="p">[</span><span class="n">cluster_id</span><span class="p">]</span><span class="w"> </span><span class="c1"># assign each cluster to its random intercept </span>


<span class="c1"># generate outcome variable yijk using equation in model 1. </span>
<span class="n">y</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">xb</span><span class="p">,</span><span class="w">  </span><span class="n">sigma_e</span><span class="p">)</span><span class="o">+</span><span class="n">clust.vec</span>

<span class="c1"># combine into a dataframe </span>

<span class="n">clust.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="o">=</span><span class="n">trt</span><span class="p">,</span><span class="w"> </span><span class="n">cluster.assigned</span><span class="o">=</span><span class="n">cluster_id</span><span class="p">,</span><span class="w"> </span><span class="n">cluster_random_interc</span><span class="o">=</span><span class="n">clust.vec</span><span class="p">)</span><span class="w"> </span><span class="c1"># add icc, number of clusters at a later date. </span>

<span class="c1"># sanity checks. </span>
<span class="nf">table</span><span class="p">(</span><span class="n">cluster_id</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="p">)</span><span class="w"> </span><span class="c1"># make sure that no cluster has both intervention and control. </span>
<span class="nf">table</span><span class="p">(</span><span class="n">cluster_id</span><span class="p">)</span>
<span class="n">trt.cluster</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>          trt
cluster_id   0   1
        1   88   0
        2    0 115
        3   91   0
        4    0  92
        5  107   0
        6   98   0
        7    0 113
        8    0  99
        9  103   0
        10  94   0
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cluster_id
  1   2   3   4   5   6   7   8   9  10 
 88 115  91  92 107  98 113  99 103  94 
</pre></div>
</div>
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>0</li><li>1</li><li>0</li><li>1</li><li>0</li><li>0</li><li>1</li><li>1</li><li>0</li><li>0</li></ol>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">clust.df</span><span class="o">$</span><span class="n">cluster.assigned</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">cluster.assigned</span><span class="p">)</span>
<span class="n">clust.df</span><span class="o">$</span><span class="n">group</span><span class="o">=</span><span class="nf">ifelse</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">trt</span><span class="o">==</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;intervention&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;control&#39;</span><span class="p">)</span>
<span class="w">                      </span>
<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w"> </span>

<span class="n">plot.overall</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">clust.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cluster.assigned</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span><span class="w">  </span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">group</span><span class="p">))</span><span class="o">+</span><span class="nf">scale_color_brewer</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s">&quot;Dark2&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">ylim</span><span class="p">(</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">))</span><span class="o">+</span>
<span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;Doctor&#39;s ID&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s">&quot;Outcome&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="c1">#face = &quot;bold&quot;, </span>
<span class="w">                            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">),</span><span class="w"> </span>
<span class="w">     </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="w"> </span><span class="p">)</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span>

<span class="n">plot.overall</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1f37859ef2fdd8a0f838710ea9ab4dbcdafb1ed6b74f9e245591e5e652df606b.png" src="_images/1f37859ef2fdd8a0f838710ea9ab4dbcdafb1ed6b74f9e245591e5e652df606b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># check if intervention is different from control if we ignore cluster variable. </span>
<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w"> </span>
<span class="n">box.p</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">clust.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">group</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_boxplot</span><span class="p">()</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span><span class="o">+</span>
<span class="nf">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">[</span><span class="n">clust.df</span><span class="o">$</span><span class="n">trt</span><span class="o">==</span><span class="m">0</span><span class="p">]</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">[</span><span class="n">clust.df</span><span class="o">$</span><span class="n">trt</span><span class="o">==</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="s">&#39;dashed&#39;</span><span class="p">,</span>
<span class="w">           </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="n">box.p</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/71d48e92d8a2967009c1201c5331123a428502b92be08cb0fabdcb98225bcb60.png" src="_images/71d48e92d8a2967009c1201c5331123a428502b92be08cb0fabdcb98225bcb60.png" />
</div>
</div>
<p><span class="math notranslate nohighlight">\(\textbf{Finding}\)</span></p>
<p>For the above scenario, we expect that the estimate of the treatment effect will be affected by the number of clusters. If the number of clusters is small, then it will be difficult to estimate the treatment effect. Let alone trying to estimate its variance.</p>
<p>We also expect that if the observations are highly correlated and we have a small number of clusters, we will have difficulties estimating the treatment effect. In addition, we will have a significant reduction in power as icc increases ( demonstrated in previous discussions).</p>
<p><span class="math notranslate nohighlight">\(\color{red}{ \text{ToDo:}}\)</span> Repeate the scenarios above for nsim=1000 and check if the treatment effect is affected by how
correlated the observations are.</p>
<p><span class="math notranslate nohighlight">\(\textbf{4. Randomize treatment within a cluster}\)</span></p>
<p>This is called complete block design. That is, the patients are assigned to clusters and then randomized to either intervention or control. This randomization happens within each cluster.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Randomize to treatment but assign to clusters in a controlled manner as described above</span>

<span class="nf">options</span><span class="p">(</span><span class="n">scipen</span><span class="o">=</span><span class="m">999</span><span class="p">)</span>
<span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="w"> </span><span class="c1"># treatment effect. </span>
<span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span>
<span class="c1"># calculate the required sample size for cluster randomization. Suppose that we have a fixed number of clusters and that there are equal number of subjects within each cluster. </span>
<span class="n">n.group1</span><span class="o">=</span><span class="nf">cont.sample.size</span><span class="p">(</span><span class="n">m1</span><span class="o">=</span><span class="m">9.0</span><span class="p">,</span>
<span class="w">                 </span><span class="n">m2</span><span class="o">=</span><span class="m">9.0</span><span class="o">+</span><span class="n">beta</span><span class="p">,</span>
<span class="w">                 </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_e</span><span class="p">,</span>
<span class="w">                 </span><span class="n">type_I_error</span><span class="o">=</span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span>
<span class="w">                 </span><span class="n">type_II_error</span><span class="o">=</span><span class="m">0.2</span><span class="p">)</span>


<span class="n">k</span><span class="o">=</span><span class="m">10</span><span class="w"> </span><span class="c1"># 10, 20, 50, 100 , the number of equal sized clusters</span>
<span class="n">ni</span><span class="o">=</span><span class="m">400</span><span class="w"> </span><span class="c1"># a fixed number of subjects per treatment group</span>
<span class="n">N</span><span class="o">=</span><span class="n">ni</span><span class="o">*</span><span class="m">2</span><span class="w"> </span><span class="c1"># total number of patients in the trial. </span>

<span class="c1"># calculate the variance for cluster random effect. </span>
<span class="n">icc</span><span class="o">=</span><span class="m">0.5</span><span class="w">   </span><span class="c1">#k/(n.group1) # maximum allowable icc for the current number of clusters is  k/n.group1</span>

<span class="n">sigma_b</span><span class="o">=</span><span class="n">icc</span><span class="o">*</span><span class="n">sigma_e</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">icc</span><span class="p">)</span>


<span class="c1">## Assign to clusters in a controlled fashion. </span>
<span class="n">cluster.assigment</span><span class="o">=</span><span class="nf">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>

<span class="c1"># Randomize patients to treatment within each cluster </span>
<span class="n">trt</span><span class="o">=</span><span class="kc">NULL</span>
<span class="n">cluster.count</span><span class="o">=</span><span class="nf">as.vector</span><span class="p">(</span><span class="nf">table</span><span class="p">(</span><span class="n">cluster.assigment</span><span class="p">))</span><span class="w"> </span><span class="c1"># count </span>

<span class="nf">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">){</span>
<span class="n">trt</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="o">==</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="nf">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">cluster.count</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">prob</span><span class="o">=</span><span class="m">0.5</span><span class="p">)}</span>


<span class="c1"># # x-beta </span>
<span class="n">xb</span><span class="o">=</span><span class="n">beta</span><span class="o">*</span><span class="n">trt</span><span class="w"> </span><span class="c1"># make sure to use the treatment variable that acts behind the scene!</span>

<span class="c1"># # simulate cluster random intercept (for now)  </span>
<span class="n">clust.eff</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">sigma_b</span><span class="p">)</span><span class="w"> </span><span class="c1"># number of clusters is k</span>

<span class="n">clust.eff.vec</span><span class="o">=</span><span class="n">clust.eff</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="p">]</span><span class="w"> </span><span class="c1"># assign each cluster to its random intercept </span>

<span class="c1"># # generate outcome variable yijk using equation in model 1. </span>
<span class="n">y</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">xb</span><span class="p">,</span><span class="w">  </span><span class="n">sigma_e</span><span class="p">)</span><span class="o">+</span><span class="n">clust.eff.vec</span>

<span class="c1"># # combine into a dataframe </span>

<span class="n">clust.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="o">=</span><span class="n">trt</span><span class="p">,</span><span class="n">cluster.assigned</span><span class="o">=</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">cluster_random_interc</span><span class="o">=</span><span class="n">clust.eff.vec</span><span class="p">)</span><span class="w"> </span><span class="c1"># add icc, number of clusters at a later date. </span>

<span class="nf">head</span><span class="p">(</span><span class="n">clust.df</span><span class="p">)</span>

<span class="c1"># sanity checks</span>
<span class="nf">table</span><span class="p">(</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 6 × 4</caption>
<thead>
	<tr><th></th><th scope=col>y</th><th scope=col>trt</th><th scope=col>cluster.assigned</th><th scope=col>cluster_random_interc</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>-1.304429</td><td>0</td><td> 6</td><td> 0.6801406</td></tr>
	<tr><th scope=row>2</th><td>-0.496273</td><td>0</td><td>10</td><td>-0.6237765</td></tr>
	<tr><th scope=row>3</th><td> 1.196342</td><td>0</td><td> 6</td><td> 0.6801406</td></tr>
	<tr><th scope=row>4</th><td>-1.445568</td><td>1</td><td>10</td><td>-0.6237765</td></tr>
	<tr><th scope=row>5</th><td>-1.363310</td><td>1</td><td> 9</td><td>-0.5396045</td></tr>
	<tr><th scope=row>6</th><td> 1.504358</td><td>0</td><td> 6</td><td> 0.6801406</td></tr>
</tbody>
</table>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                 trt
cluster.assigment  0  1
               1  27 44
               2  35 37
               3  31 47
               4  43 47
               5  41 33
               6  37 55
               7  40 41
               8  38 38
               9  50 38
               10 43 35
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">clust.df</span><span class="o">$</span><span class="n">cluster.assigned</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">cluster.assigned</span><span class="p">)</span>
<span class="n">clust.df</span><span class="o">$</span><span class="n">group</span><span class="o">=</span><span class="nf">ifelse</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">trt</span><span class="o">==</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;intervention&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;control&#39;</span><span class="p">)</span>
<span class="w">                      </span>
<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w"> </span>

<span class="n">plot.overall</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">clust.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cluster.assigned</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span><span class="w">  </span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">group</span><span class="p">))</span><span class="o">+</span><span class="nf">scale_color_brewer</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s">&quot;Dark2&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">ylim</span><span class="p">(</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">))</span><span class="o">+</span>
<span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;Doctor&#39;s ID&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s">&quot;Outcome&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="c1">#face = &quot;bold&quot;, </span>
<span class="w">                            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">),</span><span class="w"> </span>
<span class="w">     </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="w"> </span><span class="p">)</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span>

<span class="n">plot.overall</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5d2bd286750ea05227943480e58afedba61fd22216d7df888581a8453cc98e90.png" src="_images/5d2bd286750ea05227943480e58afedba61fd22216d7df888581a8453cc98e90.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># check if intervention is different from control if we ignore cluster variable. </span>
<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w"> </span>
<span class="n">box.p</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">clust.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cluster.assigned</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">group</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_boxplot</span><span class="p">()</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span>

<span class="c1"># check if intervention is different from control if we ignore cluster variable. </span>
<span class="n">box.p2</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">clust.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">group</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_boxplot</span><span class="p">()</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span><span class="o">+</span>
<span class="nf">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">[</span><span class="n">clust.df</span><span class="o">$</span><span class="n">trt</span><span class="o">==</span><span class="m">0</span><span class="p">]</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">[</span><span class="n">clust.df</span><span class="o">$</span><span class="n">trt</span><span class="o">==</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="s">&#39;dashed&#39;</span><span class="p">,</span>
<span class="w">           </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="nf">grid.arrange</span><span class="p">(</span><span class="n">box.p</span><span class="p">,</span><span class="n">box.p2</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fe453989ce611a7d279425a0532ebf4943f4f0546df1d7ccee569dd65144cadb.png" src="_images/fe453989ce611a7d279425a0532ebf4943f4f0546df1d7ccee569dd65144cadb.png" />
</div>
</div>
<p><span class="math notranslate nohighlight">\(\textbf{5. Randomize to treatment and then to clusters. Include cluster/treatment interaction as a random slope}\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Randomize to treatment but assign to clusters in a controlled manner as described above</span>

<span class="nf">options</span><span class="p">(</span><span class="n">scipen</span><span class="o">=</span><span class="m">999</span><span class="p">)</span>
<span class="n">beta</span><span class="o">=</span><span class="m">0.2</span><span class="w"> </span><span class="c1"># treatment effect. </span>
<span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span>
<span class="c1"># calculate the required sample size for cluster randomization. Suppose that we have a fixed number of clusters and that there are equal number of subjects within each cluster. </span>
<span class="n">n.group1</span><span class="o">=</span><span class="nf">cont.sample.size</span><span class="p">(</span><span class="n">m1</span><span class="o">=</span><span class="m">9.0</span><span class="p">,</span>
<span class="w">                 </span><span class="n">m2</span><span class="o">=</span><span class="m">9.0</span><span class="o">+</span><span class="n">beta</span><span class="p">,</span>
<span class="w">                 </span><span class="n">sd</span><span class="o">=</span><span class="n">sigma_e</span><span class="p">,</span>
<span class="w">                 </span><span class="n">type_I_error</span><span class="o">=</span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span>
<span class="w">                 </span><span class="n">type_II_error</span><span class="o">=</span><span class="m">0.2</span><span class="p">)</span>


<span class="n">k</span><span class="o">=</span><span class="m">10</span><span class="w"> </span><span class="c1"># 10, 20, 50, 100 , the number of equal sized clusters</span>
<span class="n">ni</span><span class="o">=</span><span class="m">500</span><span class="w"> </span><span class="c1"># a fixed number of subjects per treatment group</span>
<span class="n">N</span><span class="o">=</span><span class="n">ni</span><span class="o">*</span><span class="m">2</span><span class="w"> </span><span class="c1"># total number of patients in the trial. </span>

<span class="c1"># calculate the variance for cluster random effect. </span>
<span class="n">icc</span><span class="o">=</span><span class="m">0.5</span><span class="w">   </span><span class="c1">#k/(n.group1) # maximum allowable icc for the current number of clusters is  k/n.group1</span>

<span class="n">sigma_b</span><span class="o">=</span><span class="n">icc</span><span class="o">*</span><span class="n">sigma_e</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">icc</span><span class="p">)</span>


<span class="c1"># Randomize patients to treatment </span>
<span class="n">trt</span><span class="o">=</span><span class="nf">rbinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">prob</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>

<span class="n">trt</span><span class="o">=</span><span class="nf">sort</span><span class="p">(</span><span class="n">trt</span><span class="p">)</span><span class="w"> </span><span class="c1"># sort (we sort it because of the way clusters are assigned.)</span>

<span class="c1">## Assign to clusters in a controlled fashion. </span>
<span class="n">cluster.assigment</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">each</span><span class="o">=</span><span class="n">ni</span><span class="o">/</span><span class="n">k</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">each</span><span class="o">=</span><span class="n">ni</span><span class="o">/</span><span class="n">k</span><span class="w"> </span><span class="p">))</span>

<span class="c1"># # x-beta </span>
<span class="n">xb</span><span class="o">=</span><span class="n">beta</span><span class="o">*</span><span class="n">trt</span><span class="w"> </span><span class="c1"># make sure to use the treatment variable that acts behind the scene!</span>

<span class="c1"># # simulate cluster random intercept + random slope. </span>
<span class="n">varcov.mat</span><span class="o">=</span><span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">,</span><span class="w"> </span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">sigma_b</span><span class="o">/</span><span class="m">0.9</span><span class="p">),</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="c1"># </span>
<span class="n">varcov.mat</span>
<span class="n">clust.eff</span><span class="o">=</span><span class="nf">mvrnorm</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">),</span><span class="w"> </span><span class="n">varcov.mat</span><span class="p">)</span><span class="w"> </span><span class="c1">#rnorm(n=k, mean=0, sigma_b) # number of clusters is k</span>

<span class="n">clust.eff.mat</span><span class="o">=</span><span class="n">clust.eff</span><span class="p">[</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="c1"># assign each cluster to its random intercept </span>

<span class="c1"># # # generate outcome variable yijk using equation in model 1. </span>
<span class="n">y</span><span class="o">=</span><span class="nf">rnorm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">xb</span><span class="p">,</span><span class="w">  </span><span class="n">sigma_e</span><span class="p">)</span><span class="o">+</span><span class="n">clust.eff.mat</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span><span class="o">+</span><span class="n">clust.eff.mat</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span><span class="o">*</span><span class="n">trt</span>

<span class="c1"># # combine into a dataframe </span>
<span class="n">cluster_random_eff</span><span class="o">=</span><span class="n">clust.eff.mat</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">cluster_random_eff</span><span class="p">)</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;randm interc&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;randm slope&#39;</span><span class="p">)</span>
<span class="n">clust.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="o">=</span><span class="n">trt</span><span class="p">,</span><span class="n">cluster.assigned</span><span class="o">=</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">cluster_random_eff</span><span class="p">)</span><span class="w"> </span><span class="c1"># add icc, number of clusters at a later date. </span>

<span class="nf">head</span><span class="p">(</span><span class="n">clust.df</span><span class="p">)</span>
<span class="c1"># sanity checks</span>
<span class="nf">table</span><span class="p">(</span><span class="n">cluster.assigment</span><span class="p">,</span><span class="w"> </span><span class="n">trt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A matrix: 2 × 2 of type dbl</caption>
<tbody>
	<tr><td>1.00</td><td>0.010000</td></tr>
	<tr><td>0.01</td><td>1.111111</td></tr>
</tbody>
</table>
</div><div class="output text_html"><table class="dataframe">
<caption>A data.frame: 6 × 5</caption>
<thead>
	<tr><th></th><th scope=col>y</th><th scope=col>trt</th><th scope=col>cluster.assigned</th><th scope=col>randm.interc</th><th scope=col>randm.slope</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td> 0.100215345</td><td>0</td><td>1</td><td>0.1832196</td><td>-0.5558782</td></tr>
	<tr><th scope=row>2</th><td> 0.288048272</td><td>0</td><td>1</td><td>0.1832196</td><td>-0.5558782</td></tr>
	<tr><th scope=row>3</th><td>-0.039350599</td><td>0</td><td>1</td><td>0.1832196</td><td>-0.5558782</td></tr>
	<tr><th scope=row>4</th><td> 0.001140946</td><td>0</td><td>1</td><td>0.1832196</td><td>-0.5558782</td></tr>
	<tr><th scope=row>5</th><td> 0.121737138</td><td>0</td><td>1</td><td>0.1832196</td><td>-0.5558782</td></tr>
	<tr><th scope=row>6</th><td>-0.436143282</td><td>0</td><td>1</td><td>0.1832196</td><td>-0.5558782</td></tr>
</tbody>
</table>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                 trt
cluster.assigment  0  1
               1  77 23
               2  50 50
               3  50 50
               4  50 50
               5  50 50
               6  50 50
               7  50 50
               8  50 50
               9  50 50
               10 50 50
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># check if intervention is different from control if we ignore cluster variable. </span>
<span class="n">clust.df</span><span class="o">$</span><span class="n">cluster.assigned</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">cluster.assigned</span><span class="p">)</span>
<span class="n">clust.df</span><span class="o">$</span><span class="n">group</span><span class="o">=</span><span class="nf">ifelse</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">trt</span><span class="o">==</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;intervention&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;control&#39;</span><span class="p">)</span>
<span class="w">                      </span>
<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w"> </span>
<span class="n">box.p3</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">clust.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cluster.assigned</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">group</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_boxplot</span><span class="p">()</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span><span class="o">+</span>
<span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;Doctor&#39;s ID&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">)</span>

<span class="c1"># check if intervention is different from control if we ignore cluster variable. </span>
<span class="n">box.p4</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">clust.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">group</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_boxplot</span><span class="p">()</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span><span class="o">+</span>
<span class="nf">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">clust.df</span><span class="o">$</span><span class="n">y</span><span class="p">[</span><span class="n">clust.df</span><span class="o">$</span><span class="n">trt</span><span class="o">==</span><span class="m">0</span><span class="p">]</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
<span class="c1"># geom_hline(yintercept=median(clust.df$y[clust.df$trt==1] ), linetype=&#39;dashed&#39;,</span>
<span class="c1">#            color = &quot;grey&quot;, linewidth=1)</span>


<span class="c1">#grid.arrange(box.p,box.p2,ncol=2, top=&#39;complete block rct&#39;)</span>
<span class="c1">#grid.arrange(box.p3,box.p4,ncol=2, top=&#39;contaminated rct with random slope/treatment interaction&#39;)</span>

<span class="n">box.cluster.treatment.interact</span><span class="o">=</span><span class="w"> </span><span class="nf">arrangeGrob</span><span class="p">(</span><span class="n">box.p3</span><span class="p">,</span><span class="n">box.p4</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="c1">#generates g</span>
<span class="nf">ggsave</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="nf">paste0</span><span class="p">(</span><span class="n">tab_fig_path</span><span class="p">,</span><span class="s">&quot;sources_of_variability_with_interaction.svg&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">       </span><span class="n">plot</span><span class="o">=</span><span class="n">box.cluster.treatment.interact</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="m">25</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="o">=</span><span class="m">8</span><span class="w"> </span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Findings</p>
<p>We see a clear and consitent treatment difference within each cluster. This signifies cluster-treatment interaction as encoded in the data-generating model. But does it induce a difference in variability within the clusters themselves?</p>
<p>It also appears as though the behaviour from random slope-treatment interaction produce similar results as in the case of commplete block randomization. The only difference is that in the former, some clusters may indicate that control group is doing better than the intervention group.</p>
<p>The interaction between cluster-treatment is included in this session for completeness but will not be explored further. Interpretation of the estimated treatment effect becomes an issue of concern. As recommended in the ICH, this should only be explored as a secondary objective.</p>
<p><strong>Todo:</strong> Figure out how to calculate icc in the presence of random slope.</p>
<p><span class="math notranslate nohighlight">\(\textbf{Evaluate the impact of clustering scheme on type I error}\)</span></p>
<p>Motivated by the arguments in <em>‘’Kahan, B. C., &amp; Morris, T. P. (2013). Assessing potential sources of clustering in individually randomised trials. BMC medical research methodology, 13(1), 1-9.’’</em> paper</p>
<p>If clustering is ignorable, then there is minimal impact on type I error or standard error estimates even if ICC&gt;0. However, even if it is ignorable and the ICC&gt;0, excluding it from the model decreases statistical power.</p>
<p>Carry out simulation to verify these claims.</p>
<p>Note that the estimated treatment effect is not the issue, the issue is whether we get correct type I and II errors.</p>
<p><span class="math notranslate nohighlight">\(\textbf{Evaluate the impact of clustering scheme on power}\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">N</span><span class="o">=</span><span class="m">400</span><span class="o">*</span><span class="m">2</span>
<span class="n">k</span><span class="o">=</span><span class="m">400</span>
<span class="n">nsim</span><span class="o">=</span><span class="m">500</span>
<span class="n">beta</span><span class="o">=</span><span class="m">0.2</span>
<span class="n">exp.pwr</span><span class="o">=</span><span class="m">0.8</span>
<span class="c1"># see effect on power as icc increases</span>
<span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span>
<span class="n">icc.from.tau</span><span class="o">=</span><span class="nf">function</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">){</span>
<span class="w">    </span><span class="nf">return</span><span class="p">(</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="w"> </span><span class="n">sigma_b</span><span class="o">/</span><span class="p">(</span><span class="n">sigma_b</span><span class="o">+</span><span class="n">sigma_e</span><span class="p">),</span><span class="w"> </span><span class="m">2</span><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="p">}</span>

<span class="n">sigma_b.vec</span><span class="o">=</span><span class="nf">matrix</span><span class="p">(</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">),</span><span class="w"> </span><span class="n">nrow</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1"># match Min&#39;s tau values </span>

<span class="n">icc.vec</span><span class="o">=</span><span class="nf">apply</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">sigma_b.vec</span><span class="p">,</span><span class="w"> </span><span class="n">MARGIN</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="o">=</span><span class="n">icc.from.tau</span><span class="p">)</span>


<span class="n">icc.vs.pwr.df.random</span><span class="o">=</span><span class="kc">NULL</span>
<span class="nf">for </span><span class="p">(</span><span class="w"> </span><span class="n">ix</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">icc.vec</span><span class="p">)){</span>
<span class="w">    </span><span class="n">icc.vs.pwr.df.random</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">=</span><span class="nf">beta.hats.func</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
<span class="w">            </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="n">icc.vec</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
<span class="w">            </span><span class="n">nsim</span><span class="o">=</span><span class="n">nsim</span><span class="p">,</span>
<span class="w">          </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="s">&#39;random&#39;</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">icc.vs.pwr.df.control</span><span class="o">=</span><span class="kc">NULL</span>
<span class="nf">for </span><span class="p">(</span><span class="w"> </span><span class="n">ix</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">icc.vec</span><span class="p">)){</span>
<span class="w">    </span><span class="n">icc.vs.pwr.df.control</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">=</span><span class="nf">beta.hats.func</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
<span class="w">            </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="n">icc.vec</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
<span class="w">            </span><span class="n">nsim</span><span class="o">=</span><span class="n">nsim</span><span class="p">,</span>
<span class="w">          </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="s">&#39;control&#39;</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">]</span>
<span class="p">}</span>


<span class="n">icc.vs.pwr.df.cluster</span><span class="o">=</span><span class="kc">NULL</span>
<span class="nf">for </span><span class="p">(</span><span class="w"> </span><span class="n">ix</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">icc.vec</span><span class="p">)){</span>
<span class="w">    </span><span class="n">icc.vs.pwr.df.cluster</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">=</span><span class="nf">beta.hats.func</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
<span class="w">            </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="n">icc.vec</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
<span class="w">            </span><span class="n">nsim</span><span class="o">=</span><span class="n">nsim</span><span class="p">,</span>
<span class="w">          </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="s">&#39;cluster&#39;</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">icc.vs.pwr.df.complete</span><span class="o">=</span><span class="kc">NULL</span>
<span class="nf">for </span><span class="p">(</span><span class="w"> </span><span class="n">ix</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">icc.vec</span><span class="p">)){</span>
<span class="w">    </span><span class="n">icc.vs.pwr.df.complete</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">=</span><span class="nf">beta.hats.func</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
<span class="w">            </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="n">icc.vec</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
<span class="w">            </span><span class="n">nsim</span><span class="o">=</span><span class="n">nsim</span><span class="p">,</span>
<span class="w">          </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="s">&#39;complete&#39;</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">]</span>
<span class="p">}</span>


<span class="n">icc.vs.pwr.df.control.interact</span><span class="o">=</span><span class="kc">NULL</span>
<span class="nf">for </span><span class="p">(</span><span class="w"> </span><span class="n">ix</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">icc.vec</span><span class="p">)){</span>
<span class="w">    </span><span class="n">icc.vs.pwr.df.control.interact</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">=</span><span class="nf">beta.hats.func</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
<span class="w">            </span><span class="n">sigma_e</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">icc</span><span class="o">=</span><span class="n">icc.vec</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
<span class="w">            </span><span class="n">nsim</span><span class="o">=</span><span class="n">nsim</span><span class="p">,</span>
<span class="w">          </span><span class="n">cluster.assign.type</span><span class="o">=</span><span class="s">&#39;control.interact&#39;</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">est.pwr.vec</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">icc.vs.pwr.df.random</span><span class="p">,</span>
<span class="w">                  </span><span class="n">icc.vs.pwr.df.control</span><span class="p">,</span><span class="w"> </span>
<span class="w">                  </span><span class="n">icc.vs.pwr.df.cluster</span><span class="p">,</span>
<span class="w">                  </span><span class="n">icc.vs.pwr.df.complete</span><span class="p">,</span><span class="w"> </span>
<span class="w">              </span><span class="n">icc.vs.pwr.df.control.interact</span><span class="p">,</span><span class="w"> </span>
<span class="w">              </span><span class="nf">rep</span><span class="p">(</span><span class="n">exp.pwr</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">icc.vs.pwr.df.complete</span><span class="p">)</span><span class="w"> </span><span class="p">))</span>

<span class="n">cluster.scheme</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;random cluster&#39;</span><span class="p">,</span><span class="s">&#39;contaminated RCT&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                      </span><span class="s">&#39;cluster RCT&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;complete block RCT&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;contaminated RCT w\ interaction&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;simple RCT&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">each</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">icc.vec</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>

<span class="n">pwr.vs.icc.df</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">icc</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="n">icc.vec</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">),</span><span class="w"> </span><span class="n">tau</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">),</span><span class="w"> </span><span class="m">6</span><span class="p">),</span>
<span class="w">                         </span><span class="n">est.power</span><span class="o">=</span><span class="n">est.pwr.vec</span><span class="p">,</span><span class="w"> </span>
<span class="w">                         </span><span class="n">key</span><span class="o">=</span><span class="n">cluster.scheme</span><span class="w"> </span><span class="p">)</span>
<span class="n">pwr.vs.icc.df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 24 × 4</caption>
<thead>
	<tr><th scope=col>icc</th><th scope=col>tau</th><th scope=col>est.power</th><th scope=col>key</th></tr>
	<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th></tr>
</thead>
<tbody>
	<tr><td>0.09</td><td>0.1</td><td>0.81</td><td>random cluster                </td></tr>
	<tr><td>0.50</td><td>1.0</td><td>0.49</td><td>random cluster                </td></tr>
	<tr><td>0.60</td><td>1.5</td><td>0.35</td><td>random cluster                </td></tr>
	<tr><td>0.67</td><td>2.0</td><td>0.25</td><td>random cluster                </td></tr>
	<tr><td>0.09</td><td>0.1</td><td>0.78</td><td>contaminated RCT              </td></tr>
	<tr><td>0.50</td><td>1.0</td><td>0.52</td><td>contaminated RCT              </td></tr>
	<tr><td>0.60</td><td>1.5</td><td>0.23</td><td>contaminated RCT              </td></tr>
	<tr><td>0.67</td><td>2.0</td><td>0.07</td><td>contaminated RCT              </td></tr>
	<tr><td>0.09</td><td>0.1</td><td>0.80</td><td>cluster RCT                   </td></tr>
	<tr><td>0.50</td><td>1.0</td><td>0.53</td><td>cluster RCT                   </td></tr>
	<tr><td>0.60</td><td>1.5</td><td>0.37</td><td>cluster RCT                   </td></tr>
	<tr><td>0.67</td><td>2.0</td><td>0.40</td><td>cluster RCT                   </td></tr>
	<tr><td>0.09</td><td>0.1</td><td>0.79</td><td>complete block RCT            </td></tr>
	<tr><td>0.50</td><td>1.0</td><td>0.51</td><td>complete block RCT            </td></tr>
	<tr><td>0.60</td><td>1.5</td><td>0.36</td><td>complete block RCT            </td></tr>
	<tr><td>0.67</td><td>2.0</td><td>0.26</td><td>complete block RCT            </td></tr>
	<tr><td>0.09</td><td>0.1</td><td>0.80</td><td>contaminated RCT w interaction</td></tr>
	<tr><td>0.50</td><td>1.0</td><td>0.46</td><td>contaminated RCT w interaction</td></tr>
	<tr><td>0.60</td><td>1.5</td><td>0.28</td><td>contaminated RCT w interaction</td></tr>
	<tr><td>0.67</td><td>2.0</td><td>0.20</td><td>contaminated RCT w interaction</td></tr>
	<tr><td>0.09</td><td>0.1</td><td>0.80</td><td>simple RCT                    </td></tr>
	<tr><td>0.50</td><td>1.0</td><td>0.80</td><td>simple RCT                    </td></tr>
	<tr><td>0.60</td><td>1.5</td><td>0.80</td><td>simple RCT                    </td></tr>
	<tr><td>0.67</td><td>2.0</td><td>0.80</td><td>simple RCT                    </td></tr>
</tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w"> </span>
<span class="n">pwr.vs.icc.df</span><span class="o">$</span><span class="n">key</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">pwr.vs.icc.df</span><span class="o">$</span><span class="n">key</span><span class="p">)</span>
<span class="n">plot7</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">pwr.vs.icc.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">icc</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">est.power</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">key</span><span class="p">))</span><span class="o">+</span>
<span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span>
<span class="w">    </span><span class="n">color</span><span class="o">=</span><span class="n">key</span>
<span class="p">),</span><span class="w"> </span><span class="n">lwd</span><span class="o">=</span><span class="m">1.0</span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_point</span><span class="p">()</span><span class="o">+</span><span class="nf">scale_color_brewer</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s">&quot;Dark2&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="c1">#ylim(0,0.2)+</span>
<span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;icc&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s">&quot;estimated power&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="c1">#face = &quot;bold&quot;, </span>
<span class="w">                            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&#39;power vs icc, sample size=&#39;</span><span class="p">,</span><span class="n">N</span><span class="p">))</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span>

<span class="n">plot7</span>
<span class="c1">#ggsave(file=paste0(tab_fig_path,&quot;power_vs_icc_by_samplesize.svg&quot;), plot=plot7, width=15, height=5 )</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/76b1702a3e1082db5ab019350a3bf21b4871bc9253cf54b1126eb5395689f32b.png" src="_images/76b1702a3e1082db5ab019350a3bf21b4871bc9253cf54b1126eb5395689f32b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="w"> </span>
<span class="n">pwr.vs.icc.df</span><span class="o">$</span><span class="n">key</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">pwr.vs.icc.df</span><span class="o">$</span><span class="n">key</span><span class="p">)</span>
<span class="n">plot7</span><span class="o">=</span><span class="nf">ggplot</span><span class="p">(</span><span class="n">pwr.vs.icc.df</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">tau</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">est.power</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">key</span><span class="p">))</span><span class="o">+</span>
<span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span>
<span class="w">    </span><span class="n">color</span><span class="o">=</span><span class="n">key</span>
<span class="p">),</span><span class="w"> </span><span class="n">lwd</span><span class="o">=</span><span class="m">1.0</span><span class="p">)</span><span class="o">+</span>
<span class="nf">geom_point</span><span class="p">()</span><span class="o">+</span><span class="nf">scale_color_brewer</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s">&quot;Dark2&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">scale_x_discrete</span><span class="p">(</span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="nf">factor</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)),</span><span class="w"> </span><span class="n">expand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="m">0.0</span><span class="p">))</span><span class="o">+</span>
<span class="c1">#ylim(0,1)+</span>
<span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;tau&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s">&quot;power&quot;</span><span class="p">)</span><span class="o">+</span>
<span class="nf">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="c1">#face = &quot;bold&quot;, </span>
<span class="w">                            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="o">+</span>
<span class="nf">ggtitle</span><span class="p">(</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&#39;power vs tau, sample size=&#39;</span><span class="p">,</span><span class="n">N</span><span class="p">))</span><span class="o">+</span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">))</span>


<span class="n">plot7</span>
<span class="c1">#ggsave(file=paste0(tab_fig_path,&quot;power_vs_icc_by_trial_type_&quot;,k,&quot;_clusters.svg&quot;), plot=plot7, width=10, height=5 )</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/019d94ea40e080017d24733b63dd3a942778c7204e5e5a2870f6d7cdf3e2e8d4.png" src="_images/019d94ea40e080017d24733b63dd3a942778c7204e5e5a2870f6d7cdf3e2e8d4.png" />
</div>
</div>
<p>Note that the observed results is a function of fixed sample size, number of clusters, icc and exclusion of clusters in the estimation.
In fact, if we decrease the number of clusters from 100 to 10, the power plot for cluster RCT changes substantially ( small number of clusters increases the instability of treatment estimate).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#ggsave(file=paste0(tab_fig_path,&quot;power_vs_icc_by_trial_type_&quot;,k,&quot;_clusters.svg&quot;), plot=plot7, width=10, height=5 )</span>
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            name: "ir",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Elly Kipkogei
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>